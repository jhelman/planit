{% load planner_extras %}

<!DOCTYPE html>

<head>
    <title>PlanIt</title>
    
    
    <script type="text/javascript" src="{{ STATIC_URL }}jquery-1.7.2.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}jquery-ui/js/jquery-ui-1.8.20.custom.min.js"></script>
    <!-- <script type="text/javascript" src="jquery-ui/development-bundle/ui/jquery.ui.droppable.js"></script> -->
    
    
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}bootstrap/css/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}fullcalendar/fullcalendar/fullcalendar.css"/>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}nanoscroller/nanoscroller.css"/>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}main.css"/>
    
    
    <script type="text/javascript" src="{{ STATIC_URL }}bootstrap/js/bootstrap.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}bootstrap/js/bootstrap-tooltip.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}bootstrap/js/bootstrap-popover.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}bootstrap/js/bootstrap-alert.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}bootstrap/js/bootstrap-tab.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}bootstrap/js/bootstrap-dropdown.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}clickoutside/clickoutside.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}nanoscroller/jquery.nanoscroller.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}spin/spin.min.js"></script>
    
    
    
    
    <!-- <script type="text/javascript" src="{{ STATIC_URL }}jquery-week-calendar/jquery.weekcalendar.js"></script> -->
    
    <script type="text/javascript" src="{{ STATIC_URL }}fullcalendar/fullcalendar/fullcalendar.js"></script>
    
        
    
    <script type="text/javascript">
		
		/* Date object creation utility function */
		
		var MONDAY = 23;
        
        function makeNewEvent(day, startTime, endTime, courseName, isAdded, isWarning) {
            
            var dayNum;
                        
            if (day == 'M') {
                dayNum = MONDAY;
            } else if (day == 'T') {
                dayNum = MONDAY + 1;
            } else if (day == 'W') {
                dayNum = MONDAY + 2;
            } else if (day == 'R') {
                dayNum = MONDAY + 3;
            } else if (day == 'F') {
                dayNum = MONDAY + 4;
            } else {
                dayNum = MONDAY;
            }
                                    
            return {
                'start': new Date(2012, 3, dayNum, parseInt(startTime.substring(0, 2), 10), parseInt(startTime.substring(3, 5), 10)), 
                'end': new Date(2012, 3, dayNum, parseInt(endTime.substring(0, 2), 10), parseInt(endTime.substring(3, 5), 10)), 
                'title': courseName,
                'allDay': false,
                'color': (isWarning ? '#ffc40d' : (isAdded ? '#54cc33' : 'none'))
            };
            
        }
        
        
        function createEventObjects(courseName, offering, isAdded, isWarning) {
            var eventObjects = [];
                        
            for (var i = 0; i < offering.weekdays.length; i++) {
                eventObjects.push(makeNewEvent(offering.weekdays.charAt(i), offering.start_time,
                    offering.end_time, courseName, isAdded, isWarning));
            }
            
            return eventObjects;
        }
        
        function collectDatesForTerm(termID) {
            
            var term = plan.getTermById(termID);
            
            var eventArray = [];
            for (var i in term.courses) {
                if ((term.courses)[i] == undefined) {
                    continue;
                }
                $.merge(eventArray, (term.courses)[i].eventObjects);
            }
            return eventArray;
            
        }
		
		/* From Django website */
		jQuery(document).ajaxSend(function(event, xhr, settings) {
		    function getCookie(name) {
		        var cookieValue = null;
		        if (document.cookie && document.cookie != '') {
		            var cookies = document.cookie.split(';');
		            for (var i = 0; i < cookies.length; i++) {
		                var cookie = jQuery.trim(cookies[i]);
		                // Does this cookie string begin with the name we want?
		                if (cookie.substring(0, name.length + 1) == (name + '=')) {
		                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
		                    break;
		                }
		            }
		        }
		        return cookieValue;
		    }
		    function sameOrigin(url) {
		        // url could be relative or scheme relative or absolute
		        var host = document.location.host; // host + port
		        var protocol = document.location.protocol;
		        var sr_origin = '//' + host;
		        var origin = protocol + sr_origin;
		        // Allow absolute or scheme relative URLs to same origin
		        return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
		            (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
		            // or any other URL that isn't scheme relative or absolute i.e relative.
		            !(/^(\/\/|http:|https:).*/.test(url));
		    }
		    function safeMethod(method) {
		        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
		    }

		    if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
		        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
		    }
		});
	
        var termNames = new Array();
		{% for name in term_names %}
		termNames.push('{{ name }}');
		{% endfor %}
		
		var years = new Array();
		var yearNums = new Array();
		{% for year in years %}
		var start_num = {{ year.start_num }}
		years.push(start_num + '-' + (start_num + 1));
		yearNums.push(start_num);
		{% endfor %}
		
		function convertYearToLongForm(year) {
			return year + '-' + (year + 1)
		}
		
		


        /* Begin Javascript Object representing the model */
    
        function FourYearPlan(planName, major) {
            this.planName = planName;
            this.major = major;
            this.units = 0;
            this.terms = new Array();
			this.exemptCourseNames = new Array();
			this.exemptions = new Object();
            for (var i in termNames) {
                for (var j in years) {
                    var termID = termNames[i] + years[j];
                    this.terms[termID] = new Term(termID, this);
                }
            }
            this.generalReqs = new Array();
            this.majorReqs = new Array();
        }
        
        FourYearPlan.prototype.makeTotalReqGroups = function() {
            var totalReqGroups = [];
            $.merge(totalReqGroups, this.generalReqs);
            $.merge(totalReqGroups, this.majorReqs);
            
            return totalReqGroups;
        }
        
        
        FourYearPlan.prototype.getRequirementGroup = function(reqGroupName) {
            var totalReqGroups = this.makeTotalReqGroups();
            for (var i in totalReqGroups) {
                if (totalReqGroups[i].name == reqGroupName) {
                    return totalReqGroups[i];
                }
            }
            
            return false;
        }
        
        
        FourYearPlan.prototype.getRequirement = function(reqName, reqGroupNames) {
            var totalReqGroups = this.makeTotalReqGroups();
            
            for (var i in totalReqGroups) {
                if ($.inArray(totalReqGroups[i].name, reqGroupNames) == -1) {
                    continue;
                }
                var reqs = totalReqGroups[i].reqs;
                for (var j in reqs) {
                    if (reqs[j].cName == makeCondensedName(reqName)) {
                        return reqs[j];
                    }
                }   
                
            }
            
            return false;
        }
        
        
        FourYearPlan.prototype.getTerm = function(termNumber, yearNumber) {
            return this.terms[termNames[termNumber] + years[yearNumber]];
        }
        
        FourYearPlan.prototype.getTermById = function(termID) {
            return this.terms[termID];
        }
		
		FourYearPlan.prototype.getCourseDictionary = function() {
			var dict = new Object();
			for (var t in this.terms) {
				var term = this.terms[t];
				for (var c in term.courses) {
				    if ((term.courses)[c] != undefined && !(term.courses)[c].isAdded) {
					    if (dict[c] == undefined) {
					        dict[c] = [term.courses[c]];
				        } else {
				            dict[c].push(term.courses[c]);
			            }
				    }
				}
			}
			return dict;
		}
		
		FourYearPlan.prototype.addExemption = function(courseName, exemption, req, tlGroup) {
		    courseName = makeCondensedName(courseName);
		    addCourseReqs(exemption, true, req, tlGroup);			
			this.exemptions[courseName] = exemption;
			if ($.inArray(courseName, this.exemptCourseName) == -1) {
				this.exemptCourseNames.push(courseName);
			}
		}
		
		FourYearPlan.prototype.removeExemption = function(courseName, req, tlGroup) {
		    courseName = makeCondensedName(courseName);
            if (this.exemptions[courseName] != undefined) {
                var e = this.exemptions[courseName];
                this.exemptions[courseName] = undefined;
                removeCourseReqs(e, true, req, tlGroup);
				var index = $.inArray(courseName, this.exemptCourseNames);
				if (index != -1) {
					this.exemptCourseNames.splice(index, 1);
				}
            }
            
		}
		
		FourYearPlan.prototype.hasExemption = function(courseName) {
		    courseName = makeCondensedName(courseName);
		    return (this.exemptions[courseName] != undefined)
	    }
	    
    
        function Term(termID, plan) {
            this.termID = termID;
            this.units = 0;
            this.plan = plan;
            this.acceptedDragsForTerm = new Array();
            this.courses = new Array();   
        }
    
        Term.prototype.addCourse = function(course) {
            this.courses[course.cName] = course;
            this.removeDraggable(course.cName);
            if (!course.isAdded) {
                this.units += course.units;
                this.plan.units += course.units;
            }
        }
            
        Term.prototype.addDraggable = function(course) {             
            if (this.getCourse(course.cName) != false) {
                return;
            }    
            for (var i in this.acceptedDragsForTerm) {
                if ((this.acceptedDragsForTerm)[i].name == course.name) {
                    return;
                }
            }
            this.acceptedDragsForTerm.push(course);
            
        }
        
    
        function removeCourseReqs(course, isExemption, req, tlGroup) {
            
            var cName = makeCondensedName(course.name);
            
            // Course already in schedule
            var courseDict = plan.getCourseDictionary();
            if (courseDict[cName] != undefined || plan.hasExemption(cName)) {
                return;
            }
                                                  
            // Check for reqs and reqGroups
            for (var i in course.reqGroups) {
                var rg = course.reqGroups[i];
                for (var j in rg.reqs) {
                    var req = rg.reqs[j];
                    if ($.inArray(req.name, course.reqNames) == -1 ||
                        (isExemption && !course.bypassable)) {
                        continue;
                    }
                    
                    var oldF = req.isFulfilled();
                                        
                    req.numFulfilled--;
                                        
                    if (!req.isFulfilled() && oldF) {
                        rg.numFulfilled--;
                    }
                }
            }
        }
    
        Term.prototype.removeCourse = function(course) {
            this.courses[course.cName] = undefined;
            this.units -= course.units;
            this.plan.units -= course.units;
            
            removeCourseReqs(course, false, false, false);
            
        }
        
        
        Term.prototype.removeDraggable = function(courseName) {
            var pos = -1;
            for (var i in this.acceptedDragsForTerm) {
                if ((this.acceptedDragsForTerm)[i].cName == makeCondensedName(courseName)) {
                    pos = i;
                    break;
                }
            }
            
            if (pos > -1) {
                this.acceptedDragsForTerm.splice(pos, 1);
            }
        }
        
        Term.prototype.getCourse = function(courseName) {
            var course = this.courses[makeCondensedName(courseName)];
            if (course != undefined && course != null) {
                return course;
            }
            return false;
        }
    
        Term.prototype.containsCourse = function(courseName) {
            if (this.courses[makeCondensedName(courseName)] != undefined) {
                return true;
            }
            return false;
        }
        
        
        Term.prototype.removeAddedCourse = function(courseName) {
            this.courses[makeCondensedName(courseName)] = undefined;
        }
    
        // TODO maybe make this more efficient with associative array?
        Term.prototype.hasDraggable = function(courseName) {
            var dragArray = this.acceptedDragsForTerm;
            for (var i in dragArray) {
                if (dragArray[i].name == courseName) {
                    return true;
                }
            }
            return false;
        }
        
        Term.prototype.updateUnitsForCourse = function(courseName, units) {
            var baseUnits = this.units - this.courses[makeCondensedName(courseName)].units;
            this.courses[makeCondensedName(courseName)].units = units;
            this.units = baseUnits + units;
        }
    
        function Course(name, offerings, offering, minUnits, maxUnits, units, courseObj, prereqGroups, reqGroups,
                reqs, isAdded, isWarning) {
           this.name = name;
           this.cName = name.replace(" ", "");
           this.offerings = offerings; // All possible offerings in JSON
           this.offering = offering;  // The offering JSON the person is taking
           this.eventObjects = createEventObjects(this.name, this.offering.fields, isAdded, isWarning);
           this.minUnits = minUnits;
           this.maxUnits = maxUnits;
           this.units = units ? units : maxUnits;
           this.courseObj = courseObj;  // This will be the JSON
		   this.prereqGroups = prereqGroups;
		   this.reqGroups = [];
		   var reqGroupNames = [];
		   for (var i in reqGroups) {
		       this.reqGroups.push(plan.getRequirementGroup(reqGroups[i].fields.name));
		       reqGroupNames.push(reqGroups[i].fields.name);
	       }
		   this.reqNames = [];
		   for (var i in reqs) {
		       this.reqNames.push(reqs[i].fields.name);
		   } 
           this.isAdded = isAdded; 
        }
        
        // Course.prototype.getTerm = function() {
        //     console.log(offering);
        // }

        function addCourseReqs(course, isExemption, req, tlGroup) {
         			   
         	var cName = makeCondensedName(course.name);
         			   
            // Course already in schedule
            var courses = plan.getCourseDictionary()[cName];
            var courseCount = 0;
            for (var c in courses) {
                if (!(courses[c].isAdded)) {
                    courseCount++;
                }
            }
            
            var maxCourses = 0; 
            if (!isExemption) {
                maxCourses = 1;
            }
            
            if (courseCount > maxCourses || plan.hasExemption(cName)) {
                return;
            }
                                    
            // Check for reqs and reqGroups
            //console.log(course.reqGroups);
            for (var i in course.reqGroups) {
                var rg = course.reqGroups[i];
                for (var j in rg.reqs) {
                    var req = rg.reqs[j];
                    if ($.inArray(req.name, course.reqNames) == -1 ||
                        (isExemption && !req.bypassable)) {
                        continue;
                    }

					var oldF = req.isFulfilled();
					req.numFulfilled++;
					
                    if (req.isFulfilled() && !oldF) {
                        rg.numFulfilled++;
                    }
                }
            }  
            
             
        }

        Course.prototype.getTermId = function() {
            var offeringF = this.offering.fields
            return termNames[offeringF.term] + offeringF.year + '-' + (parseInt(offeringF.year) + 1);
        }

        Course.prototype.confirmCourse = function(req, tlGroup) {
            this.isAdded = false;
            for (var i in this.eventObjects) {
                (this.eventObjects)[i].color = 'none';
            }
            plan.getTermById(this.getTermId()).units += this.units;
            // console.log(plan.units);
            plan.units += this.units;
            addCourseReqs(this, false, req, tlGroup);
        }
        
        
        Course.prototype.getEventsForTermId = function(termId) {
            var expandedStr = convertFromCondensedName(termId);
            var termNum = $.inArray(expandedStr.substring(0, expandedStr.indexOf(' ')), termNames);
            var startYear = expandedStr.substring(expandedStr.indexOf(' ') + 1, expandedStr.indexOf('-'));
            
            for (var i in this.offerings) {
                if ((this.offerings)[i].fields.term == termNum && (this.offerings)[i].fields.year == startYear) {
                    this.offering = this.offerings[i];
                    return createEventObjects(this.cName, (this.offerings)[i].fields, 
                        false, false)
                }
            }
        }
        
        Course.prototype.changeEventsToTerm = function(termId) {
            this.eventObjects = this.getEventsForTermId(termId);
        }
        
        
        function Exemption(courseName, reqGroups, reqs) {
            this.name = courseName;
            this.reqGroups = [];
    		var reqGroupNames = [];
		    for (var i in reqGroups) {
		       this.reqGroups.push(plan.getRequirementGroup(reqGroups[i].fields.name));
		       reqGroupNames.push(reqGroups[i].fields.name);
	        }
		    this.reqNames = [];
		    for (var i in reqs) {
		       this.reqNames.push(reqs[i].fields.name);
    		}            
        }
        
        
        function ReqGroup(name, reqGroup) {
            this.name = name;
            this.numReqsToFulfill = parseInt(reqGroup.num_reqs_to_fulfill);
            this.reqs = new Array();
            this.numFulfilled = 0;
        }
        
        ReqGroup.prototype.isFulfilled = function() {
            if (this.numFulfilled >= this.numReqsToFulfill) {
                return true;
            }
            return false;
        }
        
        ReqGroup.prototype.addReq = function(req) {
            if ($.inArray(req, this.reqs) == -1) {
                this.reqs.push(req);
            }
        }
        
        function Req(name, req, reqGroup) {
            this.name = name;
            this.cName = makeCondensedName(name);
            this.fulfillers = new Array();
            for (var i in req.fulfillers) {
                this.fulfillers = req.fulfillers[i];
            }
            this.numCoursesToFulfill = parseInt(req.num_courses_to_fulfill);
            this.numFulfilled = 0;
            this.reqGroup = reqGroup;
            this.bypassable = req.bypassable;
        }
        
        Req.prototype.isFulfilled = function() {
            if (this.numFulfilled >= this.numCoursesToFulfill) {
                return true;
            }
            return false;
        }
        
        
        function getOffering(offerings, termNum, yearNum) {
            for (var i in offerings) {
                if (parseInt(offerings[i].fields.term) == termNum && 
                    parseInt(offerings[i].fields.year) == yearNums[yearNum]) {
                   return offerings[i];
                }
            }
            return false;
        }
    
        plan = new FourYearPlan('{{ plan.name }}', '{{ plan.major.name }}');
        
        {% autoescape off %}
		var generalReqs = {{ general_reqs }};
		for (var i in generalReqs) {
		    var rg = new ReqGroup(i, generalReqs[i]);
		    for (var j in generalReqs[i].requirements) {
		        var r = new Req(j, generalReqs[i].requirements[j], rg);
		        rg.addReq(r);
	        }
	        plan.generalReqs.push(rg);
	    }
        var majorReqs = {{ major_reqs }};
        for (var i in majorReqs) {
		    var rg = new ReqGroup(i, majorReqs[i]);
		    for (var j in majorReqs[i].requirements) {
		        var r = new Req(j, majorReqs[i].requirements[j], rg);
		        rg.addReq(r);
	        }
	        plan.majorReqs.push(rg);
	    }
        {% endautoescape %}
	
    	{% for year in years %}
    	{% for term in year.terms %}
    	var t = plan.getTerm({{ term.num }}, {{ year.year_index }});
    	{% for course in term.courses %}
		var prereqGroups = [];
		{% for group in course.prereq_groups %}
		var satisfiers = [];
		{% for c in group %}
		satisfiers.push('{{ c }}')
		{% endfor %}
		prereqGroups.push(satisfiers);
		{% endfor %}
    	{% autoescape off %}
    	var offerings = jQuery.parseJSON({{ course.offering_json }});
    	var c = new Course('{{ course.identifier }}', offerings, 
    	    getOffering(offerings, {{ term.num }}, {{ year.year_index }}), 
    	    {{ course.min_units }}, {{ course.max_units }}, {{ course.units }}, jQuery.parseJSON({{ course.course_json }})[0], 
    	    prereqGroups, {{ course.req_groups }}, {{ course.reqs }}, false, false);
    	{% endautoescape %}
		
		// add draggable information
		{% for offering in offerings|get_item:course.identifier %}
        {% if offering.year != year.start_num or offering.term.num != term.num %}
		var possibleTargetTerm = plan.getTerm({{ offering.term.num }}, {{ offering.year }} - {{ plan.start_year }});
		possibleTargetTerm.addDraggable(c);
        {% endif %}
		{% endfor %}
    	t.addCourse(c);
    	addCourseReqs(c, false);
    	{% endfor %}
    	{% endfor %}
    	{% endfor %}
		
		{% autoescape off %}
		{% for course in exempt %}
		var e = new Exemption('{{ course.identifier }}', {{ course.req_groups }}, {{ course.reqs }});
		plan.addExemption('{{ course.identifier }}', e);
		{% endfor %}
		{% endautoescape %}
		
		var minTotalUnits = 5;//{{ minUnits }};
		
		{% autoescape off %}
		var majorsJSON = jQuery.parseJSON({{ majors }});
		{% endautoescape %}
		
	        
        var classesJSON = null;
        var offeringsJSON = null;
		var prereqsJSON = null;
		var reqsJSON = null;
		var reqGroupsJSON = null;
        
        /* End Javascript Object representing the model */
        
        
        var dragTerm = null;
        var dropTerm = null;
		var prereqViolations = null;
        
        function makeDrag(draggableElemStr) {
            // Reference: http://blog.petersendidit.com/post/drag-table-row-to-a-div-with-jquery/
            
            var elemStr;
            if (draggableElemStr == false) {
                elemStr = '.course';
            } else {
                elemStr = draggableElemStr;
            }
            
            $(elemStr).draggable({revert: 'invalid',

                helper: function (event) {
                    var copy = $(event.currentTarget).clone();
                    // copy.find('.icon-trash').unbind('onclick');
                    copy.find('.info-over').hide();
                    copy.css('z-index', '1000');
                    copy.css('background-color', '#d9edf7');
                    return copy.appendTo('body');
                },

                start: function (event, ui) {
					prereqViolations = new Object();
                    var courseName = ui.helper.find('.courseName').html();
                    dragTerm = $(this).closest('.quarter-div').attr('id');
                    var course = plan.getTermById(dragTerm).getCourse(courseName);
                    
                    turnOffQDivMouse();
                    
                    $(this).find('.info-over').hide();
                    $(this).closest('.quarter-div').find('.calendar-over').hide();
                    
                    // Need to try to stop any interaction (disable ALL rollovers)
                    
                    // $('.units-div').tooltip({'title': '', 'placement': 'top'});
                    // $('.course').off('mouseover');
                    // $('.course').off('mouseout');
                    
                    for (var i in termNames) {
                       for (var j in years) {
                           var termStr = termNames[i] + years[j];
                           if (dragTerm == termStr) {
                               continue;
                           }
                           
                           // Evaluate for errors (then warnings after)
                           if (plan.getTerm(i, j).containsCourse(courseName)) {
                               $('#' + termStr + '-drag-cover').html("<h4>Already taking " + courseName + 
                                   " during this quarter.</h4>");
                               $('#' + termStr + '-drag-cover').show();
                               continue;
                           } else if (!plan.getTerm(i, j).hasDraggable(courseName)) {
                                $('#' + termStr + '-drag-cover').html("<h4>" + courseName + 
                                    " not offered this quarter.</h4>");
                                $('#' + termStr + '-drag-cover').show();
                                continue;
                           }
                           
                           var warningArray = evalForWarningOffering(termStr, dragTerm, course, true);
                           
                           var warningStr = "";
                           warningStr = createWarningStringOffering(warningStr, warningArray);
                           
                           // No warnings for the quarter
                           if (warningStr == "") {
                               continue;
                           }
                           
                           
                           // Display for warnings
                           var pos = warningStr.indexOf('<br/>');
                           if (pos != -1) {
                               warningStr = warningStr.substring(0, pos);
                           }
                           
                           $('#' + termStr).css('background-color', '#f3eed2');
                           $('#' + termStr + '-units-div').empty();
                           $('#' + termStr + '-units-div').html('<div class="units">' + warningStr + '</div>');
                                                      
                       }
                    }
                },

                stop: function (event, ui) {
                    // $('.units-div').tooltip({'title': 'Show Calendar', 'placement': 'top'});
                    // $('.course').on('mouseover', function () {
                    //     $(this).find('.info-over').show();
                    // });
                    // 
                    // $('.course').on('mouseout', function () {
                    //     $(this).find('.info-over').hide();
                    // });
                    
                    // alert($(event.currentTarget).attr('id'));
                    for (var i in termNames) {
                           for (var j in years) {
                               var termStr = termNames[i] + years[j];
                               $('#' + termStr + '-drag-cover').hide();
                               // if ($('#' + termStr + '-added-units').length == 0 || dragTerm == termStr) {
                                   returnCellToColor($('#' + termStr));
                                   $('#' + termStr + '-units-div').html('<span class="units">' + plan.getTerm(i, j).units + 
                                        '</span>' +
       						            '<span class="calendar-over" onclick="openCalendar(\'' + termStr + '\', this);">' + 
                                        '<span class="calendar-button"><i class="icon-calendar"></i></span>' + 
                                        '</span>&nbsp;<span class="added-units" id="' + termStr + 
                                        '-added-units" style="display: none"></span>');
                                   
                                   // $('#' + termStr + '-units-div').html('<span class="units" ' + 
                                   //                                     'id="' + termStr + '-units">' + plan.getTerm(i, j).units + '</span>' +
                                   //                                     '<span class="calendar-over" onclick="openCalendar(\'{{ term.condensedName }}\', this);>' + 
                                   //                                     '<span class="calendar-button"><i class="icon-calendar"></i></span>' + 
                                   //                                     '</span>' + 
                                   //                                     '&nbsp;<span class="added-units" id="{{ term.condensedName }}-added-units" ' + 
                                   //                                     'style="display: none"></span>');

                               // }

                           }
                       }
                    
                    // console.log("__________");

                    turnOnQDivMouse();
                    doQDivMouseOut($('#' + dragTerm));
					if (dropTerm != null) {
					    doQDivMouseOver($('#' + dropTerm));
				    }
					dropTerm = null;
                    prereqViolations = null;
                }
            });
        
        }
        
        function returnCellToColor(elem) {
            elem.css('background-color', '#fdfdfd');
            // var yearIndex = getYearArrayIndex(elem.attr('id'));
            //           elem.css('background-color', (((yearIndex % 2) == 0) ? '#eaeaea': '#f7f7f7'));
        }
        
        
        function makeDrop() {
            {% for year in years %}
			{% for term in year.terms %}
						
			$('#{{ term.condensedName }}').droppable({
				
				accept: function (elem) {
				    if (plan.getTermById('{{ term.condensedName }}').hasDraggable(elem.find('.courseName').html())) {
				        return true;
			        }
			        return false;
				},
				
				over: function (event, ui) {
				    if ($(this).find('.added-units').length > 0) { 
				        $(this).css('background-color', '#dff0d8');
                    }
					var violations = prereqViolations['{{ term.condensedName }}'];
					if (violations) {
						for (var k in violations) {
							var courseName = violations[k];
							highlightCourse(courseName, 'course-missing-prereq', false);
						}
					}
			    },
			    
			    out: function (event, ui) {
                    if ($(this).find('.added-units').length > 0) { 
			            returnCellToColor($(this));
                    }
					var violations = prereqViolations['{{ term.condensedName }}'];
					if (violations) {
						for (var k in violations) {
							var courseName = violations[k];
							unhighlightCourse(courseName, 'course-missing-prereq', false);
						}
					}
					
                },
				
				
				drop: function (event, ui) {
				    var courseName = ui.draggable.find('.courseName').html();
					
					var violations = prereqViolations['{{ term.condensedName }}'];
					if (violations) {
						for (var k in violations) {
							unhighlightCourse(violations[k], 'course-missing-prereq', false);
						}
					}
					
                    $('#{{ term.condensedName }}-courses').prepend(ui.draggable);
					
					dropTerm = '{{ term.condensedName }}';
					
                    var course = plan.getTermById(dragTerm).getCourse(courseName);
					plan.getTermById(dragTerm).removeCourse(course);
                    plan.getTermById('{{ term.condensedName }}').addCourse(course);
                    course.changeEventsToTerm('{{ term.condensedName }}');
                    plan.getTermById(dragTerm).addDraggable(course);
                    plan.getTermById('{{ term.condensedName }}').removeDraggable(courseName);
					ui.draggable.attr('id', '{{ term.condensedName }}' + makeCondensedName(courseName));
                    // $('#{{ term.condensedName }}')., course.units, false);
                    
                    updateQuarterUnitsUI('{{ term.condensedName }}', course.units, false);
					updateQuarterUnitsUI(dragTerm, -course.units, false);
					
						
					var oldTermYear = convertFromCondensedName(dragTerm).split(" ");
					var oldTermName = oldTermYear[0];
					var oldTerm = termNames.indexOf(oldTermName);
					var oldYear = parseInt(oldTermYear[1].split("-"))
					var newTermYear = convertFromCondensedName('{{ term.condensedName }}').split(" ");
					var newTermName = newTermYear[0];
					var newTerm = termNames.indexOf(newTermName);
					var newYear = parseInt(newTermYear[1].split("-"))
					var data = new Object();
					data['old_term'] = oldTerm;
					data['old_year'] = oldYear;
					data['new_term'] = newTerm;
					data['new_year'] = newYear;
					data['course'] = course.name;
					data['plan'] = plan.planName;
					$.ajax({
						type: 'POST',
						url: '/moveCourse/',
						data: data,
						success: function(data, textStatus, jqXHR) {
							ajaxMessage(courseName +  " Moved", SUCCESS);
						},
						
						error: function(jqXHR, textStatus, errorThrown) {
							ajaxMessage("An error occurred moving "
								+ courseName, ERROR);
						}
						
					});
					
				}
			});
			{% endfor %}
			{% endfor %}   
        }
        
        
        
                
        $(document).ready(function () {
                                                
            {% for year in years %}
			{% for term in year.terms %}
			{% for course in term.courses%}
			makePopoverForCourse('{{ term.condensedName }}', plan.getTermById('{{ term.condensedName }}').getCourse('{{ course.condensedID }}'));
            // $('#{{ term.condensedName|add:course.condensedID }}').popover({'title': '{{ course.identifier }}', 'content': '{{ course.title }}', 'placement': 'right'});
			{% endfor %}
			{% endfor %}
			{% endfor %}
			
            returnHome(true);
                  
            updateTotalUnits(plan.units); 
            
            $('#account-settings-modal').on('hidden', function () {
                $('#account-settings-modal').hide();
            });
            
            $('#new-plan-modal').on('hidden', function () {
                $('#new-plan-modal').hide();
            });
                 
            
            // Static
            // $('.icon-move').tooltip({'title': 'Move Course', 'placement': 'top'});
            // $('.icon-trash').tooltip({'title': 'Delete Course', 'placement': 'top'});
            // $('.icon-calendar').tooltip({'title': 'View Schedule', 'placement': 'right'});
            // $('.icon-info-sign').tooltip({'title': 'Unit Count', 'placement': 'bottom'});
            // $('.units-rollover').tooltip({'title': 'Change Units', 'placement': 'top'});
                        
            // $('.nano').nanoScroller({preventPageScrolling: true});
            
            
            // $('.units').on('click', function(event) { clickChangeUnits(this) });
            
            $('.dropdown-toggle').dropdown();            
            makeDrag(false);
            makeDrop();
            
            $('#new-plan-modal').modal({'show': false});
            $('#account-settings-modal').modal({'show': false});
            $('#schedule-modal').modal({'show': false});
			
            // $('#schedule-modal-calendar').fullCalendar({ 
            //                 firstDay: 1,
            //                 weekends: false,
            //                 header: false,
            //                 defaultView: 'agendaWeek',
            //                 slotMinutes: 30,
            //                 height: 300,
            //                 allDaySlot: false,
            //                 columnFormat: {week: 'dddd'}
            //             });
			
            

            $('#schedule-modal').on('shown', function () {
                $('#schedule-modal-calendar').fullCalendar('addEventSource', eventsToShow);
            });
            
            $('#schedule-modal').on('hide', function () {
                $('#schedule-modal-calendar').fullCalendar('removeEvents');
            });
            
            $('#schedule-modal').on('hidden', function () {
                $('#schedule-modal').hide();
            });
            
           turnOnQDivMouse();
           
           // $('.units-div').tooltip({'title': 'Show Calendar', 'placement': 'top'});
           
           
           // Show delete button           
           $('.course').on('mouseover', function () {
               $(this).find('.info-over').show();
               $(this).find('.grab-over').show();
               
           });
          
           $('.course').on('mouseout', function () {
               $(this).find('.info-over').hide();
               $(this).find('.grab-over').hide();
               
           });
            
        });       
        
        function turnHeadingsColor(id, color) {
            $('#' + years[getYearArrayIndex(id)]).css('background-color', color);
            $('#' + getTermName(id)).css('background-color', color);
        }
        
        function doQDivMouseOver(elem) {
            // elem.css('background-color', '#d9edf7'); 
            //     turnHeadingsColor(elem.attr('id'), '#d9edf7');
            var events = collectDatesForTerm(elem.attr('id'));
            if (events.length != 0) {
                elem.find('.calendar-over').show();
            }
        }
        
        function doQDivMouseOut(elem) {
            // var yearIndex = getYearArrayIndex(elem.attr('id'));
            //           elem.css('background-color', (((yearIndex % 2) == 0) ? '#eaeaea': '#f7f7f7'));
            //           $('#' + years[yearIndex]).css('background-color', 
            //              (((yearIndex % 2) == 0) ? '#eaeaea': '#f7f7f7'));
            //          $('#' + getTermName(elem.attr('id'))).css('background-color', 'white');
           elem.find('.calendar-over').hide();
        }
        
        function turnOnQDivMouse() {
            $('.quarter-div').on('mouseover', function () {
               doQDivMouseOver($(this));
            });

            $('.quarter-div').on('mouseout', function () {
                doQDivMouseOut($(this));
            });
        }
        
        function turnOffQDivMouse() {
            $('.quarter-div').off('mouseover');
            $('.quarter-div').off('mouseout');   
        }
                
        
        function getYearArrayIndex(id) {
            for (var i in years) {
                if (id.indexOf(years[i]) != -1) {
                    return i;
                }
            }
            return -1;
        }
        
        function getTermArrayIndex(id) {
             for (var i in termNames) {
                    if (id.indexOf(termNames[i]) != -1) {
                        return i;
                    }
                }
            return -1;
        }
        
        function getTermName(id) {
            for (var i in termNames) {
                if (id.indexOf(termNames[i]) != -1) {
                    return termNames[i];
                }
            }
        }
        
		var deletionPrereqViolations = null; 
                
        function removeCourse(infoElem) {
			
            var courseElem = $(infoElem).closest('.course');
            var courseName = courseElem.find('.courseName').html();
            var qDiv = courseElem.closest('.quarter-div');
            
            var course = plan.getTermById(qDiv.attr('id')).getCourse(courseName);
            
            doQDivMouseOut(qDiv);
            turnOffQDivMouse(qDiv);
            // turnHeadingsColor(qDiv.attr('id'), '#f2dede');
            // qDiv.css('background-color', '#f2dede');
                        
            courseElem.find('.info-over').hide();
            courseElem.find('.grab-over').hide();
            courseElem.popover('hide');
            
            var cover = qDiv.find('.cover');
            var alertBox = qDiv.find('.delete-alert');
            
            alertBox.find('.alert-heading').html('Delete ' + courseName + '?');
            alertBox.find('.alert-body').html('Are you sure you want to delete ' + courseName + '?');
            alertBox.find('.alert-delete-course-id').html(courseElem.attr('id'));
            alertBox.find('.alert-delete-course-name').html(courseName);
                        
            alertBox.css('left', qDiv.position().left + 25);
            alertBox.css('top', qDiv.position().top + 25);
            cover.css('left', qDiv.position().left);
            cover.css('top', qDiv.position().top);
                        
            qDiv.find('.cover').fadeIn();
            // updateAddedUnits(qDiv.attr('id'), course.units, false, true);
            
            alertBox.fadeIn();
			
			deletionPrereqViolations = new Array();
			var yearNum = getYearArrayIndex(qDiv.attr('id'));
			var termNum = getTermArrayIndex(qDiv.attr('id'));
			for (var i = yearNum; i < years.length; i++) {
				for (var j = 0; j < termNames.length; j++) {
					if (i == yearNum && j <= termNum) {
						continue;
					}
					var term = plan.getTerm(j, i);
					for (var key in term.courses) {
						var c = (term.courses)[key];
						if (c == undefined) continue;
						for (var k = 0; k < c.prereqGroups.length; k++) {
							var group = c.prereqGroups[k];
							if ($.inArray(course.cName, group) != -1) {
								var result = checkBackwardForMissingPrereq(i, j, c, course);
								if (result) {
									deletionPrereqViolations.push(result);
								}
							}
						}
					}
					
					
				}
			}
			for (var k in deletionPrereqViolations) {
				var courseName = deletionPrereqViolations[k];
				highlightCourse(courseName, 'course-missing-prereq', true);
			}
        }
        
        
        function cancelDeleteCourse(quarterID) {
            var qDiv = $('#' + quarterID);
            
            qDiv.find('.delete-alert').hide();
            qDiv.find('.cover').hide();
            
            // turnHeadingsColor(qDiv.attr('id'), '#d9edf7');
            // qDiv.css('background-color', '#d9edf7');
            turnOnQDivMouse(qDiv);
            
            // resetAddedUnits(quarterID);
			for (var k in deletionPrereqViolations) {
				var courseName = deletionPrereqViolations[k];
				unhighlightCourse(courseName, 'course-missing-prereq', true);
			}
			deletionPrereqViolations = null;
			
        }
        
        function updateTotalUnits() {

            $('#total-units').html(plan.units);
            if (plan.units < minTotalUnits) {
                $('#total-units-icon').html('<i class="icon-exclamation-sign"></i>');
                $('#total-units-icon').find('i').tooltip({title: 'Need ' + minTotalUnits + ' units in plan', 
                    placement: 'right'});
            } else {
                $('#total-units-icon').html('');
            }   
        }
        
        function updateQuarterUnitsUI(quarterID, unitsChange, updateTotal) {
            // console.log(quarterID + ' ' + plan.getTermById(quarterID).units);
            $('#' + quarterID + '-units').html(plan.getTermById(quarterID).units);        
            if (updateTotal) {
                updateTotalUnits();
            }
        }
         
		function updateRequirementsUI() {
		    
			var bElems = $('#breadcrumb-div').find('.breadcrumb').find('li');
            for (var i = bElems.length - 1; i >= 0; i--) {
                var liElems = $('#cdiv' + i).find('.nav-tabs li');
                var len = liElems.length;
                
                // console.log(i);
                
                for (var j = 0; j < len; j++) {
                    
                    var num = 0;
                    if (i == 2) {
                        num = countClasses($(bElems[1]).find('.longName').html(), $(bElems[2]).find('.longName').html(),
                                $(liElems[j]).find('.req-name').html());
                            
                    } else if (i == 1) {
                        num = countReqs($(bElems[1]).find('.longName').html(), $(liElems[j]).find('.req-name').html());
                        
                        
                    } else if (i == 0) {
                        if ($(liElems[j]).find('.req-name').html() == "General Requirements") {
                            num = countReqGroups('general');
                        } else {
                            num = countReqGroups('major');
                        }
                        
                    }
                    
                    // console.log($(liElems[j]).find('.req-info').html() + " " + num);
                    
                    $(liElems[j]).find('.req-info').html((num == 0 ? '<i class="icon-ok"></i>' : 
                        ('<span class="badge badge-important" id="general-req-badge">' + 
                        num + '</span>')) + '</span>');
                    
                }
                
                
                
            }
		    
	    }
		
		
        function confirmDeleteCourse(quarterID) {
            var qDiv = $('#' + quarterID);
            var courseElem = $('#' + qDiv.find('.alert-delete-course-id').html());
            var course = plan.getTermById(quarterID).getCourse(courseElem.find('.courseName').html());
            var numUnits = course.units;
                        
            courseElem.remove();
                        
            var courseName = qDiv.find('.alert-delete-course-name').html();
            plan.getTermById(quarterID).addDraggable(course);
                        
            plan.getTermById(quarterID).removeCourse(course);
            
            updateQuarterUnitsUI(quarterID, parseInt("-" + numUnits), true);
            
                        
            // resetAddedUnits(quarterID);
            
            var liElem = $('#' + makeCondensedName(courseName) + '-search-result');
            if (liElem.length > 0) {
                liElem.find('.search-result-info').empty();
            }

            var courseDict = plan.getCourseDictionary();
            liElem.find('.search-result-info').html(
                (courseDict[makeCondensedName(courseName)] != undefined ? '<i class="icon-ok"></i>'
                    : (plan.hasExemption(courseName) ? '<i class="icon-check"></i>' : '')));
            liElem.find('.icon-check').tooltip({title: 'Exempt from course', placement: 'top'});
            
            cancelDeleteCourse(quarterID);
            
            updateRequirementsUI();
			
			for (var k in deletionPrereqViolations) {
				var courseName = deletionPrereqViolations[k];
				unhighlightCourse(courseName, 'course-missing-prereq', true);
			}
			deletionPrereqViolations = null;
			
			
			var termYear = convertFromCondensedName(quarterID).split(" ");
			var termName = termYear[0];
			var term = termNames.indexOf(termName);
			var year = parseInt(termYear[1].split("-"))
			var data = new Object();
			data['term'] = term;
			data['year'] = year;
			data['course'] = course.name;
			data['plan'] = plan.planName;
			$.ajax({
				type: 'POST',
				url: '/deleteCourse/',
				data: data,
				success: function(data, textStatus, jqXHR) {
					ajaxMessage(courseName +  " Deleted", SUCCESS);
				},
				
                error: function(jqXHR, textStatus, errorThrown) {
                 ajaxMessage("An error occurred deleting "
                     + courseName, ERROR);
                }
				
			});
			
        }
        
  
        function closeAddCourse() {
            clearTimeout(fading_alert_timeout);
            $('#add-course-alert').fadeOut();
        }
        
        
        
        function closeNewPlanModal() {
                
            $('#plan-name').attr('value', '');
            $('#major').attr('value', '');
            $('#track-select').closest('.control-group').hide();
                
            $('#new-plan-modal').modal('hide');
        }
            
                
        function openNewPlanModal() {
            
            tracksShown = false;
            
            for (var i in majorsJSON) {
                $('#major').append('<option value="' + majorsJSON[i].fields.name + '">' + 
                    majorsJSON[i].fields.name + '</option>');
            }
            
            var year = new Date().getFullYear();
            for (var j = 0; j < 4; j++) {
                $('#graduation-year').append('<option value="' + (year + j) + '">' + 
                    (year + j) + '</option>');
            }
            
            
            $('#new-plan-modal').modal('show');  
    		
                      
        }
        
        var tracksShown = false;
        
        function getTracksForMajor(elem) {
            
            tracksShown = true;
            
            var majorName = $(elem).attr('value');
            
            if (majorName == "") {
                $('#track-select').closest('.control-group').hide();
                return;
            }
            
            var tracks;
            for (var i in majorsJSON) {
                if (majorsJSON[i].fields.name == majorName) {
                    tracks = majorsJSON[i].fields.tracks;
                    break;
                }
            }
            
            
            $('#track-select').html('<option value="">Choose a track</option>');
            for (var j in tracks) {
                $('#track-select').append('<option value="' + tracks[j] + '">' + 
                    tracks[j] + '</option>');
            }
            $('#track-select').closest('.control-group').show();
        }
        
        
        
        
        function validateNewPlan() {
                        
            var planName = $('#plan-name').attr('value');
            var major = $('#major').attr('value');
            var track = $('#track-select').attr('value');
            
            
            
            var flag = 0;
            
            if (planName.length == 0) {
                $('#plan-name').closest('.control-group').addClass('error');
                $('#plan-name-help-block').show();
                flag = 1;
            } else {
                $('#plan-name').closest('.control-group').removeClass('error');
                $('#plan-name-help-block').hide();
                
            }
            
            if (major.length == 0) {
                $('#major').closest('.control-group').addClass('error');
                $('#major-help-block').show();
                flag = 1;
            } else {
                $('#major').closest('.control-group').removeClass('error');
                $('#major-help-block').hide();
                
            }
             

            if (tracksShown) {
                
                if (track.length == 0) {
                    $('#track-select').closest('.control-group').addClass('error');
                    $('#track-help-block').show();
                    flag = 1;
                } else {
                    $('#track-select').closest('.control-group').removeClass('error');
                    $('#track-help-block').hide();

                }
                
            }
           
            return (flag == 0 ? true : false);
            
        }
        
        
        
        function createNewPlan() {
            
            if (validateNewPlan() == false) {
                return;
            }
                          
             // TODO: Dan make a new track here
			 $("#new-plan-form").submit();
			 
        }
        
        

        
        function openAccountSettingsModal() {
            $('#account-settings-modal').modal('show');
        }
        
        function saveAccountSettings() {
            var fullname = $('#account-settings-fullname').attr('value');
            if (fullname.length == 0) {
                fullname = $('#account-settings-fullname').attr('placeholder');
            }
            
            var gradYear = $('#graduation-year').attr('value');
            console.log(gradYear);

            $('#account-settings-modal').modal('hide');
            
            
            // TODO Dan do stuff with account settings (change years of four year plan??)
            
        }
        

        
        function convertFromCondensedName(condensedName) {
            
            for (var i in termNames) {
                if (condensedName.indexOf(termNames[i]) != -1) {
                    return termNames[i] + ' ' + condensedName.substring(termNames[i].length);
                }
            }
            
            return false;
        }
        
        
        var quarterScheduleToShow = null;
        var eventsToShow = null;
        
        function openCalendar(quarterName, elem) {
            
            // $(elem).tooltip('hide');
            
            quarterScheduleToShow = quarterName;  
            
            eventsToShow = collectDatesForTerm(quarterScheduleToShow);
            
            if (eventsToShow.length == 0) {
                return;
            }
            
            $('#schedule-modal-title').html(convertFromCondensedName(quarterName) + ' Weekly Schedule');            
            
            
            $('#schedule-modal').show(0, function() {
                $('#schedule-modal-calendar').fullCalendar('destroy');
            
                var minTime = null;
                var maxTime = null;
                for (var i in eventsToShow) {
                    if (minTime == null || eventsToShow[i].start.getHours() < minTime) {
                        minTime = eventsToShow[i].start.getHours() + 
                            (eventsToShow[i].start.getMinutes() / 60);
                    }
                    if (maxTime == null || eventsToShow[i].end.getHours() > maxTime) {
                        maxTime = eventsToShow[i].end.getHours() + 
                            (eventsToShow[i].end.getMinutes() / 60);
                    
                    }
                }
                              
               var startHour;
               
               if (minTime >= 8 && maxTime <= 18) {
                   minTime = 8; 
                   maxTime = 18;
                   startHour = 8; 
               } else if (minTime >= 8 && maxTime > 18) {
                   startHour = minTime;
                   minTime = 8;
               } else if (minTime < 8 && maxTime <= 18) {
                   startHour = minTime;
                   maxTime = 18;
               } else if (minTime < 8 && maxTime > 18) {
                   startHour = minTime;
               }

               
                $('#schedule-modal-calendar').fullCalendar({ 
                    firstDay: 1,
                    weekends: false,
                    header: false,
                    defaultView: 'agendaWeek',
                    minTime: minTime,
                    maxTime: maxTime,
                    firstHour: startHour,
                    slotMinutes: 30,
                    contentHeight: 440,
                    allDaySlot: false,
                    columnFormat: {week: 'dddd'}
                });
               
                  
                $('#schedule-modal-calendar').fullCalendar('gotoDate', 2012, 3, 23);
                $('#schedule-modal').modal('show');
            });
        }
        
        
        function getJSONForCourse(courseName) {
            for (var i in classesJSON) {
                 if (classesJSON[i].fields.identifier == courseName) {
                     return classesJSON[i];
                 }
             }
        }
        
        function makeCondensedName(longName) {
            return longName.replace(" ", "");
        }
        
        
        function changeUnits(selectElem, termId, courseId, oldUnits) {

            var units = parseInt($(selectElem).attr('value'));
            updateQuarterUnitsUI(termId, -oldUnits, true);
            plan.getTermById(termId).updateUnitsForCourse(courseId, units);
            updateQuarterUnitsUI(termId, units, true);
            
            removeSelect(selectElem, units);
            
        }
        
        function removeSelect(selectElem, units) {
            var unitsElem = $(selectElem).closest('.units');
            
            unitsElem.empty();
            unitsElem.html("<div class='units-rollover'>" + units + "</div>");            
            unitsElem.find('div').tooltip({'title': 'Change Units', 'placement': 'top'});
            unitsElem.closest('table').popover('enable');
            
            unitsElem.on('click', function(event) {
               clickChangeUnits(this);
            });   
        }
        
        function clickChangeUnits(unitsElem) {
            
            $(unitsElem).closest('table').popover('hide');
            $(unitsElem).closest('table').popover('disable');
            $(unitsElem).find('.units-rollover').tooltip('hide');            
            
            var termId = $(unitsElem).closest('.quarter-div').attr('id');
            var courseId = makeCondensedName($(unitsElem).closest('table').find('.courseName').html());
            
            $(unitsElem).off('click');
            
            var oldUnits = parseInt($(unitsElem).find('div').html());
            
            $(unitsElem).empty();
            $(unitsElem).html(makeUnitsSelect(courseId, termId, oldUnits, false));
            $(unitsElem).find('select').on('change', function(event) {
                changeUnits(this, termId, courseId, oldUnits); 
            });
            $(unitsElem).find('select').on('mousedownoutside', function(event) {
                changeUnits(this, termId, courseId, oldUnits); 
            });
        }
        
        function changeSelectedUnits(selectElem, termId, courseId) {
            var units = parseInt($(selectElem).attr('value'));
            // updateAddedUnitsWithCurrent(termId, units);
            plan.getTermById(termId).getCourse(courseId).units = units;
        }
        
        
        function makeUnitsSelect(courseId, termId, oldUnits, isAdded) {
            var course = plan.getTermById(termId).getCourse(courseId);
            var minUnits = course.minUnits;
            var maxUnits = course.maxUnits;            
            var selector = "<select class='units-select'>";
            for (var i = minUnits; i <= maxUnits; i++) {
                if (i == oldUnits) {
                   selector += "<option value='" + i + "' selected>" + i + "</option>";
                } else {
                   selector += "<option value='" + i + "'>" + i + "</option>";
                }
            }
            selector += "</select>";
            return selector;
        }
        
        
        function makeAddedCourseHTML(addToElem, quarterID, courseObj, isWarning) {
            
            var className = "possible-course";
            
            if (isWarning) {
                className = "possible-course-warning";
            }
            
            addToElem.prepend('<div id="' + quarterID + makeCondensedName(courseObj.identifier) + '"' + 
                'class="course ' + className + '">' + 
                '<table><tr>' + 
                '<td class="courseName">' + courseObj.identifier + '</td>' + 
                '<td class="units">' +  makeUnitsSelect(courseObj.identifier, quarterID, courseObj.max_units, true)  
                + '</td>' + '<td class="icons"><i class="icon-ok confirm-add-class"></i>' + 
                (isWarning ? '&nbsp;&nbsp;<i class="icon-warning-sign"></i>' : '')
                + '</td></tr></table>');
                
            addToElem.find('#' + quarterID + makeCondensedName(courseObj.identifier)).width($('.course').width()); 
                 
            addToElem.find('td').width($('.course').width() / 3);
                                       
            addToElem.find('select').on('change', function(event) {
                changeSelectedUnits($(this), quarterID, courseObj.identifier, false);
            });
            
            // addToElem.find('.units').on('mouseover', function(event) {
            //     $('#' + quarterID + makeCondensedName(courseObj.identifier)).popover('hide');
            // });
                                        
        }
        
        function createWarningStringAll(warningArrayAll) {
            var warningStr = "";
            
            for (var i in warningArrayAll) {
                if (i == WARNING_ALL_DOUBLE_COURSE && warningArrayAll[i] != false) {
                       warningStr += "Course already in " + warningArrayAll[i] + "<br/>";
                }
            }
            
            return warningStr;
        }
        
        
        function createWarningStringOffering(warningStr, warningArrayOffering) {
            for (var j in warningArrayOffering) {
                if (j == WARNING_OFFERING_TIME_CONFLICT && warningArrayOffering[j] != false) {
                	warningStr += "Time conflict: " + warningArrayOffering[j] + ".<br/>";
                }
                if (j == WARNING_OFFERING_OVER_UNITS && warningArrayOffering[j] != false) {
					warningStr += "Over allowed units for quarter.<br/>";
                }
                if (j == WARNING_OFFERING_PREREQ && warningArrayOffering[j] != false) {
					if (typeof(warningArrayOffering[j]) == "string") {
						warningStr += warningArrayOffering[j] + " is missing a prerequisite.<br/>";
					} else {
						warningStr += warningArrayOffering[j][0] + " is missing a prerequisite.<br/>";
					}
                }
            }
            
            return warningStr;   
        }
		
		function formatTime(time) {
			return time.substr(0, time.length - 3);
		}
		
		function formatPrereqGroup(group) {
			if (group.length == 1) {
				return group[0];
			} else if (group.length == 2) {
				return '[' + group.join(' or ') + ']';
			} else {
				var str = group.join(', ');
				var lastComma = str.lastIndexOf(',');
				return '[' + str.substr(0, lastComma) + ', or' + str.substr(lastComma + 1) + ']'
			}
		}
		
		function makePrereqString(prereqGroups) {
			var arr = new Array()
			for (var i in prereqGroups) {
				arr.push(formatPrereqGroup(prereqGroups[i]));
			}
			return arr.join(', ');
		}
        
        function makePopoverForCourse(termId, course) {
            
            var descrip = course.courseObj.fields.description;
            if (course.courseObj.fields.description.length > 100) {
                descrip = descrip.substring(0, 100) + "...";
            }
			
			var unitsStr = '' + course.minUnits;
			if (course.maxUnits > course.minUnits) {
				unitsStr += '-' + course.maxUnits;
			}
            
			var content =  descrip + 
				'<br /><br /><b>Units:</b> ' + unitsStr +
				'<br /><b>Meets:</b> ' + course.offering.fields.weekdays + '&nbsp;' +
				formatTime(course.offering.fields.start_time) + '-' + formatTime(course.offering.fields.end_time) +
				'<br /><b>Instructor:</b> ' + course.offering.fields.instructor;
				
				if (course.prereqGroups.length > 0) {
					content += '<br /><b>Prerequisites:</b> ' + makePrereqString(course.prereqGroups);
				}
				if (course.reqNames.length > 0) {
					content += '<br /><b>Requirements:</b> ' + course.reqNames.join(', ');
				}
				
			
            $('#' + termId + makeCondensedName(course.cName)).popover({
               title: course.cName + ": " + course.courseObj.fields.title,
               content: content,
               placement: 'right'
            });
            
        }
        
        function createRolloversForAddedCourse(quarterID, courseObj, isWarning, 
                warningArrayAll, warningArrayOffering, course) {
            
            $('#plan-table').find('.icon-ok').tooltip({'title': 'Add Course', 'placement': 'top'});
            
            if (isWarning) {
            
                var warningStr = createWarningStringAll(warningArrayAll);
                
                warningStr = createWarningStringOffering(warningStr, warningArrayOffering);                
                        
                $('.icon-warning-sign').tooltip({'title': warningStr, 'placement': 'left'});
                
            }
            
            makePopoverForCourse(quarterID, course);
            
        }
        
        
        function addCourseToDraggables(courseTermId, course) {
            var offerings = course.offerings;
            for (var i in offerings) {
                var termId = termNames[parseInt(offerings[i].fields.term)] + 
                    convertYearToLongForm(parseInt(offerings[i].fields.year));
                
                var offeringCourse = plan.getTermById(termId).getCourse(course.cName);
                
                if (offeringCourse != false && !offeringCourse.isAdded) {
                    continue;
                }
                
                plan.getTermById(termId).addDraggable(course);
            }
            
            // In case course taken in >1 quarter must remove from itself
            plan.getTermById(courseTermId).removeDraggable(course.cName);
            
        }
            
        function confirmAddCourse(courseTableID) {
            
            var courseName = $('#' + courseTableID).find('.courseName').html();
            var termId = $('#' + courseTableID).closest('.quarter-div').attr('id');
            var units = parseInt($('#' + courseTableID).find('select').attr('value'));
            
            var course = plan.getTermById(termId).getCourse(courseName);
                                    
            // $('#' + courseTableID).find('.icon-ok').tooltip('hide');
            //             $('#' + courseTableID).find('.info').empty();
            //             
            //             // Remember to redraw the dragging for this course!
            //             
            //             var infoTD = $('#' + courseTableID).find('.info');
            //             infoTD.append('<i class="icon-move"></i>&nbsp;&nbsp;' + 
            //                 '<i class="icon-trash" onclick="removeCourse(this);"></i>');
            //                 
            //             infoTD.find('.icon-move').tooltip({'title': 'Move Course', 'placement': 'top'});
            //             infoTD.find('.icon-trash').tooltip({'title': 'Delete Course', 'placement': 'top'});
            //          
                        
            $('#' + courseTableID).find('.icon-ok').tooltip('hide');
            $('#' + courseTableID).popover('hide');
            $('#' + courseTableID).popover('disable');
            $('#' + courseTableID).remove();
            
            $('#' + termId + '-courses').prepend('<div id="' + termId + makeCondensedName(courseName) + '" ' + 
                'class="course"><div class="courseName">' + courseName + '</div>' +
                '<div class="grab-over">' +
                '<div class="grab-line" style="top: -7px;"></div>' +
                '<div class="grab-line" style="top: -11px;"></div>' + 
                '<div class="grab-line" style="top: -15px;"></div>' +
                '</div>' + 
                '<div class="info-over"><div class="info" onclick="removeCourse(this);">' + 
                '<i style="position: relative; top: 2px;" class="icon-remove icon-white"></i>' + 
                '</div></div></div>');                 
                
            $('#' + termId + makeCondensedName(courseName)).on('mouseover', function () {
                 $(this).find('.info-over').show();
                 $(this).find('.grab-over').show();
            });
 
            $('#' + termId + makeCondensedName(courseName)).on('mouseout', function () {
                $(this).find('.info-over').hide();
                $(this).find('.grab-over').hide();
            });
            
            makePopoverForCourse(termId, course);
                                                                           
            // resetAddedUnits(termId);
                        
            // console.log(course);            
            
            var req = getReqByBreadcrumb(makeCondensedName(courseName));
            
            course.confirmCourse(req, getTopLevelByBreadcrumb());
                                    
            cancelAddCourse(course.courseObj, course.offerings);
            
            updateRequirementsUI();
            
            updateQuarterUnitsUI(termId, units, true);
            
            makeDrag('#' + termId + course.cName);
            
            addCourseToDraggables(termId, course);
            
            // removeSelect($('#' + courseTableID).find('select'), units);
            
            // 
            // $('#' + courseTableID).removeClass('possible-course');
            // $('#' + courseTableID).removeClass('possible-course-warning');
            // $('#' + courseTableID).css('background-color', 'none');
                        
            var liElem = $('#' + makeCondensedName(courseName) + '-search-result');
                        // td class="search-result-info" align="middle">' + 
                        // (courseDict[makeCondensedName(courseShortName)] != undefined ? '<i class="icon-ok"></i>'
                        //     : '')
                        // + '</td>'
            liElem.parent().removeClass('active');
            liElem.find('.search-result-info').html('<i class="icon-ok"></i>');
            liElem.find('.search-result-info i').tooltip({title: 'Course in schedule'});
            
            liElem.unbind('mousedownoutside');

			var termYear = convertFromCondensedName(termId).split(" ");
			var termName = termYear[0];
			var term = termNames.indexOf(termName);
			var year = parseInt(termYear[1].split("-"))
			var data = new Object();
			data['term'] = term;
			data['year'] = year;
			data['course'] = course.name;
			data['plan'] = plan.planName;
			data['units'] = units;
			$.ajax({
				type: 'POST',
				url: '/addCourse/',
				data: data,
				success: function(data, textStatus, jqXHR) {
					ajaxMessage(courseName +  " Added", SUCCESS);
				},
				
				error: function(jqXHR, textStatus, errorThrown) {
					ajaxMessage("An error occurred adding "
						+ courseName, ERROR);
				}
				
				
			});
				
				
        }
        
        
        function resetAddedUnits(quarterID) {
            
            $('#' + quarterID + '-added-units').hide();
            
        }
        
        function updateAddedUnits(quarterID, units, isWarning, isDelete) {
            
            var sign = "+";
            
            if (isDelete) {
                $('#' + quarterID + '-added-units').css('color', '#bd362f');
                sign = "-";
            } else if (isWarning) {
                $('#' + quarterID + '-added-units').css('color', '#fc9c00');
            } else {
                $('#' + quarterID + '-added-units').css('color', '#54cc33');
            }         
            $('#' + quarterID + '-added-units').html('(' + sign + units + ')');        
            $('#' + quarterID + '-added-units').show();
        }
        
        function updateAddedUnitsWithCurrent(quarterID, units) {
            var sign = '+';
            if ($('#' + quarterID + '-added-units').html().indexOf('-') != -1) {
                sign = '-';
            }
            
            $('#' + quarterID + '-added-units').html('(' + sign + units + ')');        
            $('#' + quarterID + '-added-units').show();
        }
        
        var MAX_UNITS_PER_QUARTER = {{ max_units }};
        
        // TODO reevaluate when person changes number of units!!!!
        function checkIfOverUnits(termId) {
            if (plan.getTermById(termId).units > MAX_UNITS_PER_QUARTER) {
                return true;
            } 
            return false;
        }
        
		function checkBackwardForMissingPrereq(toYear, toTerm, course, exclude) {
			var prereqGroups = course.prereqGroups;
			if (prereqGroups.length == 0) return false;
			var sat = new Array(prereqGroups.length);
			var numSat = 0;
			for (var i = 0; i < sat.length; i++) {
				sat[i] = false;
			}
			var exempt = plan.exemptCourseNames;
			for (var i = 0; i < prereqGroups.length; i++) {
				for (var j = 0; j < exempt.length; j++) {
					if ($.inArray(exempt[j], prereqGroups[i]) != -1) {
						sat[k] = true;
						if (++numSat == prereqGroups.length) return false;
					}
				}
			}
			for (var i = toYear; i >= 0; i--) {
				for (var j = termNames.length - 1; j >=0; j--) {
					if (i == toYear && j >= toTerm) {
						continue;
					}
					var term = plan.getTerm(j, i);
					for (var key in term.courses) {
						var c = (term.courses)[key];
						if (c == exclude) continue;
						if (c == undefined) continue; // something else?
						for (var k = 0; k < prereqGroups.length; k++) {
							if (sat[k]) continue;
							var group = prereqGroups[k];
							if ($.inArray(c.cName, group) != -1) {
								sat[k] = true;
								if (++numSat == prereqGroups.length) return false;
							}
						}
							
					}
				}
			}
			return course.cName;
			
		}
		
        /* Take out of evalForWarningsOffering and split up into forwards and backwards...
           only call one on adding and call both on dragging
           Can then eliminate isDrag parameter (as well as from evalFromWarningsOffering) */
		   
		/*
		   Adding: Check backwards (to -> beginning) for missing prereqs for added course
		   Dragging Backward: Check backwards (to -> beginning) for missing prereqs for dragged course
		   Dragging Forward: Check betweeen to/from quarters for courses with dragged course as prereq 
		 */
        
        // Course is course you are moving
        // Return what prereq course violates
        function checkIfPrereqViolation(toTermId, fromTermId, course, isDrag) {
			var toYear = getYearArrayIndex(toTermId);
			var toTerm = getTermArrayIndex(toTermId);
			if (fromTermId == false) {
				return checkBackwardForMissingPrereq(toYear, toTerm, course, false);
			} else {
				var fromYear = getYearArrayIndex(fromTermId);
				var fromTerm = getTermArrayIndex(fromTermId);
				if (toYear < fromYear || (toYear == fromYear && toTerm < fromTerm)) {
					return checkBackwardForMissingPrereq(toYear, toTerm, course, false);
				} else {
					/*
					  loop from fromTerm + 1 to toTerm and call the backward prereq check
					  for every course encountered that contains 'course' in its prereq groups
					*/
					var violations = false;
					for (var i = fromYear; i <= toYear; i++) {
						for (var j = 0; j < termNames.length; j++) {
							if ((i == fromYear && j <= fromTerm) || (i == toYear && j > toTerm)) continue;
							var term = plan.getTerm(j, i);
							for (var key in term.courses) {
								var c = (term.courses)[key];
								if (c == undefined) continue;
								for (var k = 0; k < c.prereqGroups.length; k++) {
									var group = c.prereqGroups[k];
									if ($.inArray(course.cName, group) != -1) {
										var result = checkBackwardForMissingPrereq(i, j, c, course);
										if (result) {
											if (!violations) violations = new Array();
											violations.push(result);
										}
									}
								}
							}
						}
					}
					prereqViolations[toTermId] = violations;
					return violations;
				}
			}
        }
        
        
        var WARNING_OFFERING_TIME_CONFLICT = 2;
        var WARNING_OFFERING_OVER_UNITS = 1;
        var WARNING_OFFERING_PREREQ = 0;
        var WARNING_ALL_DOUBLE_COURSE = 0;
        
        
        function evalForWarningOffering(toTermID, fromTermID, course, isDrag) {
            var warningArray = [];
            warningArray[WARNING_OFFERING_TIME_CONFLICT] = checkIfTimeConflict(toTermID, course, isDrag);
            warningArray[WARNING_OFFERING_OVER_UNITS] = checkIfOverUnits(toTermID);
            warningArray[WARNING_OFFERING_PREREQ] = checkIfPrereqViolation(toTermID, fromTermID, course, isDrag);
            return warningArray;
        }
        
        function evalForWarningAll(courseName) {
            var warningArray = [];            
            warningArray[WARNING_ALL_DOUBLE_COURSE] = checkIfDoubleCourse(courseName);
            return warningArray;
        }
        
        
        function checkIfDoubleCourse(courseName) {
            for (var i in years) {
                for (var j in termNames) {
                    if (plan.getTerm(j, i).containsCourse(courseName)) {
                        return termNames[j] + " " + years[i];
                    }
                }
            }
            return false;
        }
        
        function turnOnCourseHighlight(courseName) {
            if (courseName != false) {
                unhighlightCourse(courseName, 'highlight-course', false);
            }
            $('.search-result').find('a').on('mouseover', function (event) {
                var courseName = $(this).find('.shortName').html();
                highlightCourse(courseName, 'highlight-course', false);
            });

            $('.search-result').find('a').on('mouseout', function (event) {
                var courseName = $(this).find('.shortName').html();
                unhighlightCourse(courseName, 'highlight-course', false);
            });
        }
        
        function turnOffCourseHighlight() {
            $('#content-div').find('a').off('mouseover');
            $('#content-div').find('a').off('mouseout');
        }
                
        function addCourse(classLinkItem) {
            
            // $(classLinkItem).popover('hide');
                        
            if ($(classLinkItem).closest('li').hasClass('active') || $(classLinkItem).hasClass('btn')) {
                return;
            }
            
            $(classLinkItem).closest('li').addClass('active');
                                                
            var courseName = $(classLinkItem).closest('li').find('.shortName').html();
                          
            var courseObj = getJSONForCourse(courseName);
                                                            
            var offerings = jQuery.parseJSON(offeringsJSON[courseName]);
            
            $(classLinkItem).bind('mousedownoutside', function (event) {
                                                                                                
                if ($(event.target).hasClass('confirm-add-class')) {
                    var cName = $(event.target).closest('.course').find('.courseName').html();
                    var termId = $(event.target).closest('.quarter-div').attr('id');
                    confirmAddCourse(termId + makeCondensedName(cName));
                    $(classLinkItem).parent().removeClass('active');
                    $(this).unbind('mousedownoutside');
                    $(classLinkItem).off('mouseover');   
                    turnOnCourseHighlight(cName);            
                                        
                } else if ($(event.target).prop('tagName') == "BODY" ||
                    $(event.target).prop('tagName') == "HTML" ||
                    $(event.target).hasClass('search-result-cname') ||
                    $(event.target).hasClass('icon-ok') ||
                    $(event.target).hasClass('icon-remove') ||
                    $(event.target).hasClass('info') ||
                    (($(event.target).closest('li').length > 0) &&
                        $(event.target).closest('li').hasClass('req-link')) ||
                    $(event.target).hasClass('search-result-info') ||
                    (($(event.target).attr('id') != null) && 
                        ($(event.target).attr('id').indexOf("-search-result") != -1) ||
                        ($(event.target).attr('id') == "course-search")) ||
                    (($(event.target).closest('li').attr('id') != null) && 
                        ($(event.target).closest('li').attr('id').indexOf('blevel') != -1))
                    ) {             
                        cancelAddCourse(courseObj, offerings);
                        var liElem = $(classLinkItem).closest('li');
                        liElem.removeClass('active');
                        // liElem.find('icon-ok').tooltip('hide');
                        liElem.find('.btn').tooltip('hide');
                        var courseDict = plan.getCourseDictionary();
                        var courseName = liElem.find('a').attr('id').substring(0, liElem.find('a').attr('id').indexOf('-search-result'));
                        liElem.find('.search-result-info').html(
                            (courseDict[makeCondensedName(courseName)] != undefined ? '<i class="icon-ok"></i>'
                                : (plan.hasExemption(courseName) ? '<i class="icon-check"></i>' : '')));
                        liElem.find('.icon-check').tooltip({title: 'Exempt from course', placement: 'top'});
                        // liElem.find('.icon-ok').tooltip({'title': 'Course in schedule'});
                        $(this).unbind('mousedownoutside');
                        $(classLinkItem).tooltip('hide');  
                        $(classLinkItem).off('mouseover');
                        turnOnCourseHighlight(courseName);          
                }
                
                
                                
            });
            
            var warningArrayAll = evalForWarningAll(courseName);
            
            var isWarningAll = false;
            for (var i in warningArrayAll) {
                if (warningArrayAll[i] != false) {
                    isWarningAll = true;
                    break;
                }
            }
            
                
            var addClassDisplayCount = 0;
            var containsCourseFlag = false;
                                                            
            for (var i in offerings) {
                                                                                                                   
                var termId = termNames[parseInt(offerings[i].fields.term)] + 
                    convertYearToLongForm(parseInt(offerings[i].fields.year));
                                        
                // quarter out of range of schedule
                if (plan.getTermById(termId) == undefined) {
                    continue;
                }
                
                // double adding class in 1 quarter
                if (plan.getTermById(termId).containsCourse(courseName)) {
                    containsCourseFlag = true;
                    continue;
                }
                
                addClassDisplayCount++;
                var addedCourse = new Course(courseName, offerings, offerings[i], 
                        courseObj.fields.min_units, courseObj.fields.max_units, false, courseObj, 
						prereqsJSON[makeCondensedName(courseName)], jQuery.parseJSON(reqGroupsJSON[courseName]), 
						jQuery.parseJSON(reqsJSON[courseName]), true, isWarningAll);
                plan.getTermById(termId).addCourse(addedCourse);
                                            
                // evaluate quarter in which you are going to place the class to validate                
                                                                                                    
                var warningArrayOffering = evalForWarningOffering(termId, false, addedCourse, false);
                 
                var isWarningOffering = false;
                for (var i in warningArrayOffering) {
                    if (warningArrayOffering[i] != false) {
                        isWarningOffering = true;
                        break;
                    }
                }
                
                var isWarning = isWarningAll;
                if (isWarningAll == false && isWarningOffering == true) {
                    isWarning = true;
                }
                                       
                // updateAddedUnits(termId, courseObj.fields.max_units, isWarning, false);
                                                           
                makeAddedCourseHTML($('#' + termId + '-courses'), termId, courseObj.fields, isWarning);
                                
                createRolloversForAddedCourse(termId, courseObj.fields, isWarning, 
                    warningArrayAll, warningArrayOffering, addedCourse);
                        
            }
            
            if (addClassDisplayCount == 0) {
                var titleStr = (containsCourseFlag ? 'Class in schedule in all quarters offered.' :
                    'Class not offered in time at school.');
                $(classLinkItem).tooltip({'title': titleStr, 'trigger': 'manual'});
                $(classLinkItem).tooltip('show');
                $(classLinkItem).on('mouseover', function(event) {
                    $(classLinkItem).tooltip('show');
                });
                $(classLinkItem).on('mouseout', function(event) {
                    $(classLinkItem).tooltip('hide');
                });
            }
            
            
           
        }
        
        
        function checkIfTimeConflict(termId, course, isDrag) {
            
            var flag = null;
            
            var courseEvents;
            if (!isDrag) {
                courseEvents = course.eventObjects;
            } else {
                courseEvents = course.getEventsForTermId(termId);
            }
            
            var courses = plan.getTermById(termId).courses;
            
            for (var i in courses) {
                
                // Can it be null?

                if (courses[i] == undefined || courses[i].name == course.name) {
                    // alert(courseName);
                    continue;
                }
                
                var events = courses[i].eventObjects;
                            
                for (var j in events) {
                   
                    var startTime = events[j].start.getTime();
                    var endTime = events[j].end.getTime();
                   
                    for (var k in courseEvents) {
                        
                        var offeringST = courseEvents[k].start.getTime();
                        var offeringET = courseEvents[k].end.getTime();
                        
                        if ((offeringST >= startTime && offeringST < endTime) ||
                            (offeringET > startTime && offeringET <= endTime)) {
    
                            courseEvents[k].color = '#ffc40d';
                            // flag = couses[i].name;
                            flag = courses[i].name;
    
                        }
                        
                        
                    }
                   
                }
                
            }
            
            return (flag == null ? false : flag);
            
        }
        
                
        
        function cancelAddCourse(courseObj, offerings) {
           
            for (var i in offerings) {
             
                var termId = termNames[parseInt(offerings[i].fields.term)] + 
                    convertYearToLongForm(parseInt(offerings[i].fields.year));
                    
                if (plan.getTermById(termId) == undefined) {
                    continue;
                }

                var course = plan.getTermById(termId).getCourse(courseObj.fields.identifier)
                    
                // Don't delete if course is already in the plan
                if (!course.isAdded) {
                        continue;
                }
                
                $('#' + termId + course.cName).remove();
                plan.getTermById(termId).removeAddedCourse(course.name);
                
                // resetAddedUnits(termId);
                                                
            }
                        
        }
        
        function highlightCourse(courseName, cssClassName, warning) {
            var courseArr = (plan.getCourseDictionary())[courseName];
                        
            for (var x in courseArr) {
                                
                var course = courseArr[x];
                if (course.isAdded) {
                    continue;
                }
                var offering = course.offering.fields;
                var termStr = termNames[offering.term] + offering.year + '-' + (parseInt(offering.year) + 1);
            	
                $('#' + termStr + course.cName).addClass(cssClassName);
				
				if (warning) {
	                $('#' + termStr).css('background-color', '#f3eed2');
	                $('#' + termStr + '-units-div').empty();
	                $('#' + termStr + '-units-div').html('<div class="units">' + courseName + ' is missing a prerequisite</div>');
				}
           	 
            }           
            
        }
        
        
        function unhighlightCourse(courseName, cssClassName, warning) {
            
            var courseArr = (plan.getCourseDictionary())[courseName];
            
            for (var x in courseArr) {
                var course = courseArr[x];
                if (course.isAdded) {
                    continue;
                }
                var offering = course.offering.fields;
                var termStr = termNames[offering.term] + offering.year + '-' + (parseInt(offering.year) + 1);
            
                $('#' + termStr + course.cName).removeClass(cssClassName);
				
				if (warning) {
                    returnCellToColor($('#' + termStr));
                    $('#' + termStr + '-units-div').html('<span class="units">' + plan.getTermById(termStr).units + 
                         '</span>' +
			            '<span class="calendar-over" onclick="openCalendar(\'' + termStr + '\', this);">' + 
                         '<span class="calendar-button"><i class="icon-calendar"></i></span>' + 
                         '</span>&nbsp;<span class="added-units" id="' + termStr + 
                         '-added-units" style="display: none"></span>');
					
				}
           
            }
            
        }
        
        function createSearchResults(courses, isReq, reqName, num) {
                
                
            var numRequired = "all";        
            if (!isReq) {
                num = 1;
            } else {
                var bElems = $('#breadcrumb-div').find('.breadcrumb').find('li');
                req = plan.getRequirement(reqName, [$(bElems[2]).find('.longName').html()]);
                // console.log(req);
                if (courses.length != req.numCoursesToFulfill) {
                    numRequired = req.numCoursesToFulfill;
                }
            }
            // $('#search-scroll-content').empty();
                          
            var courseDict = plan.getCourseDictionary();
                                    
            var scroller = '<div id="search-scroll-div' + num + '" class="nano"' + 
                    (isReq ? ('" style="left: ' + (num * (parseInt($('#search-scroll-div0').width()) + SPACER)) + 
                        'px; ' + 'top: 0px">') : '>') + 
                    '<div id="search-scroll-content' + num +'" class="content">';
                        
            var html = scroller + '<div class="cdiv" id="cdiv' + num + '">' +
                        '<div class="requirement-heading">' +
                        (!isReq ? (courses.length == 0 ? 'No results found.' : 'Search results (' + courses.length + '): ')
                            : 'Select ' + numRequired + ' of the following:') +
                        '</div>' +
                        '<ul class="nav nav-pills nav-stacked">';

            if (courses.length == 0) {
                html += '</ul></div></div></div>';
                return html;
            }
            			            			
            for (var i in courses) {
                
                var courseShortName = makeCondensedName(courses[i].fields.identifier);
                var courseLongName = courses[i].fields.title;
                
                html += '<li class="search-result"><a href="#" id="' + 
                    makeCondensedName(courseShortName)
                    + '-search-result"><table style="height: 20px"><tr><td class="search-result-cname">' +
                    '<span class="shortName">' + courseShortName  + '</span>: ' + courseLongName +  
                    '</td><td class="search-result-info" align="middle">' + 
                    (courseDict[courseShortName] != undefined ? '<i class="icon-ok"></i>'
                        : (plan.hasExemption(courseShortName) ? '<i class="icon-check"></i>' : ''))
                    + '</td>' + 
                    '</tr></table></a></li>';
                                        
                // newHTMLObj.find('a').click(function (event) {
                //                     alert('hi');
                //                     addCourse(this);
                //                 });
                    
                // $('#' + makeCondensedName(courseShortName) + '-search-result').popover({
                //     title: courseShortName,
                //     content: courseLongName,
                //     placement: 'left'
                // });
                
            }
            
            html += '</ul></div></div></div>';
			
			
                                     
            return html;      
             
        }
        
        
        function addExemption(elem) {
            
            var btn = $(elem).closest('.btn');            
            var td = btn.closest('.search-result-info');
            var courseName = btn.attr('id').substring(0, btn.attr('id').indexOf('-button'));
                        
            var adding = false;
            if (btn.find('.icon-check').length > 0) {
                adding = true;
            } 
                                    
            btn.tooltip('hide');  
            
            td.html('<button class="btn btn-default ' +
                (adding ? 'remove-exemption' : 'add-exemption') + '" id="' + 
                makeCondensedName(courseName) + '-button" onclick="addExemption(this);"><i class="icon-' + 
                (adding ? 'remove-circle' : 'check') + '" id="' + makeCondensedName(courseName) +
                '-icon"></i></button>');
            
            var data = new Object();
			data['course'] = courseName;
			data['plan'] = plan.planName;
			data['add'] = adding;
			
			var req = getReqByBreadcrumb(makeCondensedName(courseName));
            
			
			if (adding) {
			    var e = new Exemption(courseName, jQuery.parseJSON(reqGroupsJSON[makeCondensedName(courseName)]), 
				    jQuery.parseJSON(reqsJSON[makeCondensedName(courseName)]));
                plan.addExemption(makeCondensedName(courseName), e, req, getTopLevelByBreadcrumb());
		    } else {
		        plan.removeExemption(courseName, req, getTopLevelByBreadcrumb());
	        }
	        	
	        updateRequirementsUI();
	        			
			$.ajax({
				type: 'POST',
				url: '/setExemption/',
				data: data,
				success: function(data, textStatus, jqXHR) {
					ajaxMessage((adding ? "Added exemption for " : "Removed exemption for ")
					    + courseName, SUCCESS);
				},
				
				error: function(jqXHR, textStatus, errorThrown) {
					ajaxMessage("An error occurred " + (adding ? "adding" : "removing")
						+ " the exemption for " + courseName, ERROR);
				}
			});
        }
        
        
        function refreshScroll(num) {
            $('.slider').animate({'top': 0});
            $('#search-scroll-div' + num).nanoScroller({preventPageScrolling: true});
            $('#search-scroll-div' + num).nanoScroller({scroll: 'top'});
        }
        
        function returnHome(isSetUp) {
            var numGen = countReqGroups('general');
            var numMaj = countReqGroups('major');
            var html = '<div id="search-scroll-div0" class="nano">' +
                '<div id="search-scroll-content0" class="content">' +
                    '<div class="cdiv" id="cdiv0" style="position: relative; top: 0px; left: 0px;">' +
                        '<div class="requirement-heading">Select a requirement type:</div>' +
                        '<div class="nav nav-tabs nav-stacked">' +
                            '<li class="req-link"><a href="#" onclick="getReqGroups(\'General\');">' + 
                                '<span class="req-name">General Requirements</span>' + 
                                '<span class="req-info">' + 
                                (numGen == 0 ? '<i class="icon-ok"></i>' : 
                                ('<span class="badge badge-important" id="general-req-badge">' + 
                                 numGen + '</span>')) + '</span></a></li>' + 
                            '<li class="req-link"><a href="#" onclick="getReqGroups(\'Major\');">' + 
                                '<span class="req-name">Major Requirements</span>' + 
                                '<span class="req-info">' + 
                                (numMaj == 0 ? '<i class="icon-ok"></i>' : 
                                ('<span class="badge badge-important" id="general-req-badge">' + 
                                 numMaj + '</span>')) + '</span></a></li>' +                  
                        '</div>' + 
                    '</div>' +
                '</div>' +
            '</div>';
            
            
            if (!isSetUp) {
                $('#blevel1').remove();
                $('#course-search').attr('value', '');
            }
            
            $('#blevel0').html('Home');
            $('#blevel0').addClass('active');
            
            $('#content-div').html(html); 
                        
        
            
            refreshScroll(0);
        }
                
        function getTopLevelByBreadcrumb() {
            var bElems = $('#breadcrumb-div').find('.breadcrumb').find('li');
            
            return $(bElems[1]).find('.longName').html();
            
        }
        
        
        function getReqByBreadcrumb(courseName) {
            
            var bElems = $('#breadcrumb-div').find('.breadcrumb').find('li');
            var reqName = $(bElems[bElems.length - 1]).html();
            
            var req = false;
            if (bElems.length == 3) {
                req = plan.getRequirement(makeCondensedName(courseName), 
                    [$(bElems[2]).find('.longName').html()]);
                if (req == false) {
                    req = plan.getRequirement($(bElems[2]).find('.longName').html(),
                        [$(bElems[2]).find('.longName').html()]);
                }
            } else if (bElems.length == 4) {
                req = plan.getRequirement(reqName, [$(bElems[2]).find('.longName').html()]);
            }
            
            return req;
        }
        
        function addButtonsToSearchResults() {

            $('.search-result-info').find('.icon-ok').tooltip({'title': 'Course in schedule', placement: 'top'});
            $('.search-result-info').find('.icon-check').tooltip({title: 'Exempt from course', placement: 'top'});
                        
            turnOnCourseHighlight(false);

            $('.search-result').find('a').on('click', function (event) {
                if ($(event.target).hasClass('btn') || $(event.target).hasClass('icon-ok-circle')) {
                    return;
                }
                var courseName = $(this).find('.shortName').html();
                var exemption = plan.hasExemption(courseName);
                // alert($(event.target).prop('tagName'));
				var bElems = $('#breadcrumb-div').find('.breadcrumb').find('li');
                var reqName = $(bElems[bElems.length - 1]).html();
                var byButton = true;
                if (reqName.indexOf("Search: ") == -1) {
                    var req = getReqByBreadcrumb(courseName);
                    if (!req.bypassable) {
                        byButton = false;
                    }
                }
                
                if (byButton == true) {
                    $(event.target).closest('li').find('.search-result-info .icon-ok').tooltip('hide');
                    $(event.target).closest('li').find('.search-result-info .icon-check').tooltip('hide');
                    $(event.target).closest('li').find('.search-result-info').html('<button class="btn btn-default ' +
                        (!exemption ? 'add-exemption' : 'remove-exemption') +
                        '" onclick="addExemption(this)" id="' +
                        makeCondensedName(courseName) + '-button">' +
                        '<i class="icon-' + 
                        (!exemption ? 'check' : 'remove-circle') +
                        '" id="' + makeCondensedName(courseName) +
                        '-icon"></i></button>');
                    $(this).find('.add-exemption').tooltip({title: 'Add course exemption', placement: 'top'});
                    $(this).find('.remove-exemption').tooltip({title: 'Remove course exemption', placement: 'top'});
                }
                
                turnOffCourseHighlight();
                
                addCourse(this);
            });   
        }
        
        var currentSearch;
        var cancelNext = false;
        
        function cancelNextFn() {
            removeSpinner();
            cancelNext = true;
        }
                
        function runSearch(event) {
            
            // Don't run a search if enter
            if (event.keyCode == 13) {
                return;
            }
            
            currentSearch = "";
                   
            $('#content-div').empty();
                        
            makeNewSpinner();
            
            var searchValue = $('#course-search').attr('value');
            
            if (searchValue.length == 0) {
                removeSpinner();
                returnHome(false);
                // $('#search-scroll-div').nanoScroller();
                return;
            }
            
            $('#breadcrumb-div').find('.breadcrumb').empty();
            $('#breadcrumb-div').find('.breadcrumb').html('<li class="active" id="blevel0">' + 
                '<a href="#" onclick="cancelNextFn(); returnHome(false);">Home</a></li>');
                
            cancelNext = false;
                
            moveToNextBreadcrumbLevel(1, 'Search: ' + searchValue, true);
                        
            $.ajax({
				url: '/search/' + encodeURI(searchValue) + '/10',
                success: function (data, textStatus, jqXHR) {
                    if (cancelNext == true) {
                        return;
                    }                    
                    if (data.query != $('#course-search').attr('value') || data.query == currentSearch) {
                        return;
                    }
                    removeSpinner();
                    currentSearch = data.query;
                    classesJSON = jQuery.parseJSON(data.classes);
                    offeringsJSON = data.offerings;
					prereqsJSON = data.prereq_groups;
					reqsJSON = data.reqs;
					reqGroupsJSON = data.req_groups;
                    var html = createSearchResults(classesJSON, false, false, 0);
                    $('#content-div').css('left', '0px');
                    $('#content-div').html(html);
                    addButtonsToSearchResults();
                    refreshScroll(1);
                },
                error: function (data, textStatus, jqXHR) {
                    if (cancelNext == true) {
                        return;
                    }
                    removeSpinner();
                    $('#content-div').html("<b>Search failed.  Try again.</b>");
                }
            });
        }
        
        
        var SUCCESS = 0;
        var ERROR = 1;
        var INFORMATION = 2;
        var WARNING = 3;
        
        var ajaxMsgTimeout;
        var ajaxMsgDisplayed = false;
        
        function ajaxMessage(displayStr, msgType) {
            
            var typeStr = "";
            if (msgType == SUCCESS) {
                typeStr = "alert-success";
            } else if (msgType == ERROR) {
                typeStr = "alert-error";
            } else if (msgType == INFORMATION) {
                typeStr = "alert-info";
            } else if (msgType == WARNING) {
                typeStr = "";
            }
            
            if (ajaxMsgDisplayed) {
                closeAjaxMessageNoEffect();
            }
            
            var alertMsg = $("<div class='alert ajax-alert " + typeStr + "'>" + 
                "<a href='#' class='close' onclick='closeAjaxMessageNoEffect()'>"
                + "&times;</a>" + displayStr + "</div>");
                
            $('body').append(alertMsg);
            
            alertMsg.css('left', $(window).width()/2 - $(alertMsg).width()/2);
            
            ajaxMsgTimeout = setTimeout('closeAjaxMessage()', 1000);
            
            ajaxMessageDisplayed = true;
            
        }
        
        function closeAjaxMessage() {
            $('body').find('.ajax-alert').fadeOut(function() {
                ajaxMessageDisplayed = false;
            });            
        }
        
        
        function closeAjaxMessageNoEffect() {
            $('body').find('.ajax-alert').remove();
            ajaxMessageDisplayed = false;
            clearTimeout(ajaxMsgTimeout);
        }
        
        var hasSpinner = false;
        
        function makeNewSpinner() {
            
            if (hasSpinner) {
                return;
            }
            
            var options = {
                lines: 12,
                length: 3,
                width: 2,
                radius: 5,
                color: '#888888'
            };
            
            var spin = new Spinner(options).spin();
            $('#search-spinner').append(spin.el);
            
            hasSpinner = true;
        }
        
        function removeSpinner() {
            $('#search-spinner').empty();
            hasSpinner = false;
        }
        
        function moveToNextBreadcrumbLevel(num, name, isSearch) {
            var oldNum = num - 1;
            $('#blevel' + oldNum).removeClass('active');
            $('#blevel' + oldNum).html('<a href="#">' + $('#blevel' + oldNum).html()
                 + '</a><span class="divider">/</span>');
            var newName = name;
            var len = 12;
            if (isSearch) {
                len = 30;
            }
            if (name.length > len) {
                newName = name.substring(0, len) + "...";
            }
            $('#breadcrumb-div').find('.breadcrumb').append('<li class="active" id="blevel' + num +
                '"><span>' + newName + '</span><span class="longName">' + name + '</span></li>');
        } 
        
        var SPACER = 40;
        
        function getTopLevel(tlName) {
			tlName = tlName.toLowerCase();
			if (tlName == "general") {
               return generalReqs;
            } else if (tlName == "major") {
                return majorReqs;
            }
        }
        
        function countReqGroups(tlName) {
            
            tlName = tlName.toLowerCase();
            var tl = getTopLevel(tlName);
            
            var count = 0;
            for (var i in tl) {
                count += countReqs(tlName, i);
            }
            
            return count;
        }
        
        
        function countReqs(tlName, reqGroupName) { 
            var rg = plan.getRequirementGroup(reqGroupName);
            var total = rg.numReqsToFulfill - rg.numFulfilled;
            return (total >= 0 ? total : 0);
        }
        
        
        function countClasses(tlName, reqGroupName, reqName) {
            var r = plan.getRequirement(reqName, [reqGroupName]);
            var total = r.numCoursesToFulfill - r.numFulfilled;
            return (total >= 0 ? total : 0);           
        }
        
        
        
        function getReqGroups(tlName) {
            var cDiv = $('#search-scroll-div0');
            var tl = getTopLevel(tlName);
              
            var scroller = '<div id="search-scroll-div1" class="nano" style="left: ' + 
                (parseInt(cDiv.width()) + SPACER) + 'px; ' +
                'top: 0px">' + 
                '<div id="search-scroll-content1" class="content">';          
            var html = scroller + '<div class="cdiv" id="cdiv1">' + 
                '<div class="requirement-heading">Select ' + tlName.toLowerCase() + 
                ' requirement group:</div>' +
                '<div class="nav nav-tabs nav-stacked">';
                            
            for (var i in tl) {
                var numReqs = countReqs(tlName, i);
                html += '<li class="req-link"><a href="#" onclick="getNextLevelOfReqs(this, true);">' + 
                    '<span class="req-name">' + i + '</span>' +  
                    '<span class="req-info">' + 
                    (numReqs == 0 ? '<i class="icon-ok"></i>' : 
                    ('<span class="badge badge-important" id="general-req-badge">' + 
                     numReqs + '</span>')) + '</span></a></li>';
            }
            
            html += '</div></div></div></div>';
            $('#content-div').append(html);
            
            moveToNextBreadcrumbLevel(1, tlName, false);
            
            // countReqs(reqGroup);
                        
            $('#search-scroll-div0').find('.pane').hide();
            
            $('#content-div').animate(
                {'left': -cDiv.width() - SPACER}, 500, function () {
                    $('#blevel0').html('<a href="#" onclick="moveBackNLevels(this)">' + 
                            $('#blevel0').find('a').html() + '</a><span class="divider">/</span>');
                    refreshScroll(1);         
            });
            
            
        }
        
        
        
        function getReqClasses(elem) {
            elem = $(elem);
                        
            cancelNext = false;
                        
            makeNewSpinner();
                                    
            $.ajax({
				url: '/reqSearch/' + encodeURI(elem.find('.req-name').html()) + '/10',
                success: function (data, textStatus, jqXHR) {                    
                    if (cancelNext == true) {
                        return;
                    }
                    classesJSON = jQuery.parseJSON(data.classes);
                    offeringsJSON = data.offerings;
					prereqsJSON = data.prereq_groups;
					reqsJSON = data.reqs;
					reqGroupsJSON = data.req_groups;
					var bElems = $('#breadcrumb-div').find('.breadcrumb').find('li');
                    var html = createSearchResults(classesJSON, true, elem.find('.req-name').html(), bElems.length);
                    addClassesCDiv(html, 3, elem.find('.req-name').html());
                    addButtonsToSearchResults();
                    refreshScroll(3);
                    removeSpinner();
                }, 
                error: function(data, textStatus, jqXHR) {
				    if (cancelNext == true) {
                        return;
                    }
                    removeSpinner();
				    ajaxMessage("An error occurred. Please try again.", ERROR);
			    }
            });
            
        }
        

        function addClassesCDiv(html, level, reqName) {
            
            var bElems = $('#breadcrumb-div').find('.breadcrumb').find('li');
            
            var count = $(html).find('li').length;
            
            var cDiv = $('#search-scroll-div0');
                
            moveToNextBreadcrumbLevel(bElems.length, reqName, false);
            
            $('#search-scroll-div' + (level - 1)).find('.pane').hide();
                
            $('#content-div').append(html);
            
            $('#content-div').animate(
                {'left': -bElems.length * (cDiv.width() + SPACER)}, 500, function () {
                    var cur = $('#blevel' + (bElems.length - 1));
                    cur.html('<a href="#" onclick="moveBackNLevels(this)">' + 
                          cur.find('a').html() + '</a><span class="divider">/</span>');
                    
                    refreshScroll(bElems.length);          

            });     

        }
        
        function getReqsAndClasses(liName, reqJSON, reqDisplayCount, reqName, classJSON, isForward) {
                var bElems = $('#breadcrumb-div').find('.breadcrumb').find('li');
            
                var liGroupHTML = "";
                var liClassHTML = "";
                                
                var classCount = 0;
                for (var i in classJSON) {
                    classCount++;
                    var courseShortName = classJSON[i].fields.identifier;
                    var courseLongName = classJSON[i].fields.title;
                    var courseDict = plan.getCourseDictionary();
                    liClassHTML += '<li class="search-result"><a href="#" id="' + 
                        makeCondensedName(courseShortName)
                        + '-search-result"><table style="height: 20px"><tr><td class="search-result-cname">' +
                        '<span class="shortName">' + courseShortName  + '</span>: ' + courseLongName +  
                        '</td><td class="search-result-info" align="middle">' + 
                        (courseDict[courseShortName] != undefined ? '<i class="icon-ok"></i>'
                            : (plan.hasExemption(courseShortName) ? '<i class="icon-check"></i>' : ''))
                        + '</td>' + 
                        '</tr></table></a></li>';
                 }
                                
                var reqCount = 0;
                for (var i in reqJSON.requirements) {
                    reqCount++;
                    if (((reqJSON.requirements[i]).num_courses_to_fulfill == 1 &&
                        (reqJSON.requirements[i]).fulfillers.length == 1)
                        || reqDisplayCount == 1) {
                        continue;
 
                    } 
                    // reqCount += reqJSON.requirements[i].num_courses_to_fulfill;
                                        
                     var numClasses = countClasses(liName, reqName, i);
                     liGroupHTML += '<li class="req-link"><a href="#" onclick="getReqClasses(this);">' + 
                        '<span class="req-name">' + i + '</span>' + 
                        '<span class="req-info">' + 
                        (numClasses == 0 ? '<i class="icon-ok"></i>' : 
                        ('<span class="badge badge-important" id="general-req-badge">' + 
                         numClasses + '</span>')) + '</span></a></li>';
                 }

                 var cDiv = $('#search-scroll-div0');

                 var scroller = (isForward ? ('<div id="search-scroll-div' + bElems.length +'" class="nano" style="left: ' + 
                     (bElems.length * (parseInt(cDiv.width()) + SPACER)) + 'px; ' +
                     'top: 0px">' + 
                     '<div id="search-scroll-content' + bElems.length +'" class="content">') : '');

                 var html = scroller + '<div class="cdiv" id="cdiv' + 
                    (isForward ? bElems.length : (bElems.length - 1)) +'">';
                                                                                     
                 if (liGroupHTML != "") {
                     html += '<div class="requirement-heading">Select ' + 
                        (reqCount == reqJSON.num_reqs_to_fulfill ? 'all' 
                            : reqJSON.num_reqs_to_fulfill) + 
                        ' of the following:</div>' +
                        '<div class="requirement-subheading">Course groups:</div>' + 
                        '<div class="nav nav-tabs nav-stacked">' + liGroupHTML + '</div>';
                }
                                                     
                 html += '<div class="requirement-' + (liGroupHTML != "" ? 'sub' : '') + 
                    'heading">' + 
                    (liGroupHTML != "" ? (liClassHTML != "" ? 'Courses:' : '') : 'Select ' + 
                        (classCount > reqJSON.num_reqs_to_fulfill ? reqJSON.num_reqs_to_fulfill
                            : 'all') + ' of the following courses:') + '</div>';
                     
                 html += '<ul class="nav nav-pills nav-stacked">' + liClassHTML + 
                    '</ul></div></div></div>';

                 if (isForward) {
                     $('#content-div').append(html);
                 } else {
                     $('#search-scroll-content' + (bElems.length - 1)).html(html);
                 }

                 
            
            
        }
        
        function animateForward(num) {
            var cDiv = $('#search-scroll-div0');
             $('#search-scroll-div' + (num - 1)).find('.pane').hide();

             $('#content-div').animate(
                 {'left': -num * (cDiv.width() + SPACER)}, 500, function () {
                        var cur = $('#blevel' + (num - 1));
                        cur.html('<a href="#" onclick="moveBackNLevels(this)">' + 
                              cur.find('a').html() + '</a><span class="divider">/</span>');
                        refreshScroll(num);
                        addButtonsToSearchResults();        

             });
        }
        
        
        function getNextLevelOfReqs(elemOrReqName, isForward) {
            
            var reqName = "";
            if (isForward) {
                reqName = $(elemOrReqName).find('.req-name').html();  
            } else {
                reqName = elemOrReqName;
            }
            
            // elem = $(elem);
            // 
            // var reqName = elem.find('.req-name').html();            
            
            var bElems = $('#breadcrumb-div').find('.breadcrumb').find('li');
            var reqJSON = ($(bElems[1]).find('.longName').html() == "General" ? reqJSON = generalReqs : reqJSON = majorReqs);
            reqJSON = reqJSON[reqName];
            
            var reqCount = 0;
            for (var i in reqJSON.requirements) {
                reqCount++;
            }
            
            
            var courseArr = []
            for (var i in reqJSON.requirements) {
                var req = (reqJSON.requirements[i]);
                if (((reqJSON.requirements[i]).num_courses_to_fulfill == 1 &&
                    (reqJSON.requirements[i]).fulfillers.length == 1) 
                    || reqCount == 1) {
                    for (var i in req.fulfillers) {
                       var cName = req.fulfillers[i];
                       if ($.inArray(cName, courseArr) == -1) {
                           courseArr.push(cName);
                       }
                    }
                    
                    
                }
            }
                        
            // For higher level trees - is this right?
            // for (var i = 3; i < bElems.length; i++) {
            //     reqJSON = (reqJSON.requirements)[$(bElems[i]).html()];
            // }
            
            makeNewSpinner();
            
            cancelNext = false;
                        
            var data = new Object();
			data['courseNames'] = courseArr;
			$.ajax({
				type: 'POST',
				url: '/courseInfo/',
				data: data,
				success: function(data, textStatus, jqXHR) {
				    if (cancelNext == true) {
				        return;
			        }
				    removeSpinner();
                    classesJSON = jQuery.parseJSON(data.classes);
                    offeringsJSON = data.offerings;
					prereqsJSON = data.prereq_groups;
					reqsJSON = data.reqs;
					reqGroupsJSON = data.req_groups;
                    getReqsAndClasses($(bElems[1]).html(), reqJSON, reqCount, reqName, classesJSON, isForward);
                    if (isForward) {
                        moveToNextBreadcrumbLevel(bElems.length, reqName, false);
                        animateForward(bElems.length);
                    } else {
                        animateBackward(bElems.length - 1);
                    }
				},
				
				error: function(data, textStatus, jqXHR) {
				    if (cancelNext == true) {
				        return;
			        }
				    removeSpinner();
				    ajaxMessage("An error occurred. Please try again.", ERROR);
			    }
				
			}); 
            
        }
        
        function animateBackward(num) {
            
            var cDiv = $('#search-scroll-div0');
            
            $('#search-scroll-div' + num).find('.pane').show();                
            refreshScroll(num); 
            
            $('#content-div').animate({'left': -((cDiv.width() + SPACER) * num)}, 500, function () {
                    
                var cDivs = $('#content-div').find('.nano');
                for (var j = cDivs.length; j > num; j--) {
                    $('#search-scroll-div' + j).remove();
                }
                
                addButtonsToSearchResults();        
                                
            });
        }
        
        
        function moveBackNLevels(elem) {
            cancelNextFn();
            elem = $(elem);
            var liElems = $('#breadcrumb-div').find('.breadcrumb').find('li');
            var num = parseInt(elem.closest('li').attr('id').substring(6));
            var cDiv = $('#search-scroll-div0');

            for (var i = liElems.length - 1; i > num; i--) {
                $('#blevel' + i).remove();
            }
            $('#blevel' + num).find('.divider').remove();                
            $('#blevel' + num).addClass('active');
            $('#blevel' + num).html($('#blevel' + num).find('a').html());

            // Need to reload the frame
            if (num == 2) {
                getNextLevelOfReqs($('#blevel' + num).find('.longName').html(), false);
            } else {
                animateBackward(num);
            }
            


            
        }
        
        
    </script>    
    
    
</head>



<body style="margin: 35px; background-image: url('{{ STATIC_URL }}backgrounds/pencil5.jpg');"> 
<!-- <body style="margin: 50px"> -->
    
    <!-- <div class='alert alert-success ajax-alert'><a href='#' class='close' data-dismiss='alert'>&times;</a>hi</div> -->
    
    
    <div class="navbar navbar-fixed-top">
        <div class="navbar-inner">
                <div class="container-fluid">
                
                <a href="#" class="brand"><font color="white">planit</font></a>

                                    
                <ul class="nav pull-right">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                            {{ plan.name }}&nbsp;<b class="caret"></b>  
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="#" onclick="openNewPlanModal()"><i class="icon-plus-sign"></i>&nbsp;Create New Four-Year Plan</a></li>
                            <li class="divider"></li>
							{% for p in allPlans %}
							<li><a href="/{{ p.name }}"> 
							{{ p.name }}&nbsp;
							{% if p.name == plan.name %}
							<i class="icon-ok"></i>
							{% endif %}
							</a></li>
							{% endfor %}
                        </ul>
                     </li>
                    <li class="divider-vertical"></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                            <i class="icon-user icon-white"></i>&nbsp;Jonathan Helman&nbsp;<b class="caret"></b>  
                        </a>
                        <ul class="dropdown-menu">
                        
                            <li><a href="#" onclick="openAccountSettingsModal()">Account Settings</a></li>

                            <li><a href="#">Logout</a></li>
                        </ul>
                    </li>
                </ul>
         
                
            </div>
        </div>
    </div>
    
    
    <div class="modal fade" id="new-plan-modal">
        <div class="modal-header">
            <button class="close" data-dismiss="modal">&times;</button>
            <h3>Create New Four-Year Plan</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal" id="new-plan-form" action="/createPlan/" method="POST">
                 {% csrf_token %}
                 <fieldset>
                     <div class="control-group">
                         <label class="control-label" for="plan-name">Four-Year Plan Name</label>
                         <div class="controls">
                             <input type="text" id="plan-name" name="planName"></input>
                             <p class="help-inline" id="plan-name-help-block" style="display: none;">Required</p>
                         </div>
                    </div>
                </fieldset>
                
                <fieldset>
                    <div class="control-group">
                        <label class="control-label" for="graduation-year">Graduation Year</label>
                        <div class="controls">
                            <select name="gradYear" id="graduation-year">
                            </select>
                        </div>
                   </div>
               </fieldset>
                   
                   
                 <fieldset>
                     <div class="control-group">
                         <label class="control-label" for="major">Major</label>
                         <div class="controls">
                             <select id="major" onchange="getTracksForMajor(this);" name="major">
                                 <option value="">Choose a major</option>
                             </select>
                             <p class="help-inline" id="major-help-block" style="display: none;">Required</p>
                         </div>
                    </div>
                </fieldset>
                
                
                 <fieldset>
                     <div class="control-group" style="display: none">
                         <label class="control-label" for="track">Track</label>
                         <div class="controls">
                             <select id="track-select" name="track"></select>
                             <p class="help-inline" id="track-help-block" style="display: none;">Required</p>
                         </div>
                    </div>
                </fieldset>
                

            </form>
        </div>
        
        <div class="modal-footer">
            <button class="btn" data-dismiss="modal">Cancel</button>
            <button class="btn btn-primary" onclick="createNewPlan()">Create Plan</button>
        </div>
        
    </div>   
    
    
    <div class="modal fade" id="account-settings-modal">
        <div class="modal-header">
           <button class="close" data-dismiss="modal">&times;</button>
           <h3>Account Settings: jhelman@stanford.edu</h3>
        </div>
        <div class="modal-body">
           <form class="form-horizontal" id="account-settings-form">

                <fieldset>
                    <div class="control-group">
                        <label class="control-label" for="account-settings-fullname">Full Name</label>
                        <div class="controls">
                            <input type="text" id="account-settings-fullname" placeholder="Jonathan Helman"></input>
                        </div>
                   </div>
               </fieldset>
           </form>
       </div>

       <div class="modal-footer">
           <button class="btn" data-dismiss="modal">Cancel</button>
           <button class="btn btn-primary" onclick="saveAccountSettings()">Save Account Settings</button>
       </div>

    </div>   
    
    
    
    <div class="modal fade" id="schedule-modal">
        <div class="modal-header">
           <button class="close" data-dismiss="modal">&times;</button>
           <h3><span id="schedule-modal-title"></span></h3>
        </div>
        <div class="modal-body" id="schedule-modal-body">
            <div id="schedule-modal-calendar"></div>
            
        </div>

       <div class="modal-footer">
           <button class="btn" data-dismiss="modal">Close</button>
           
       </div>

    </div>
    
    <div class="cover-inner-table">&nbsp;</div>

    <table class="inner-table"><tr>
        
        <td>
    
	        <table id="plan-table">
                <tr style="height: 30px">
                    <td class="top-left-corner">&nbsp;</td>
                    <td id="Autumn" class="quarter-label"><h4>Autumn Quarter</h4></td>
                    <td id="Winter" class="quarter-label"><h4>Winter Quarter</h4></td>
                    <td id="Spring" class="quarter-label"><div><h4>Spring Quarter</h4></div></td>
                </tr>
		
		
        		{% for year in years %}
        		<!-- Row for quart7d15c7ee4c4f173af63368495069d52b033d6f84er boxes -->
                    <!-- <tr style="background-color: #{% cycle ffffff, ffffff %}"> -->
                    <tr>
        				<td id="{{ year.year }}" class="year-label"><h4>{{ year.year }}</h4></td>
			
        				{% for term in year.terms %}
							<td class="quarter-td">
								<div class="quarter-div" id="{{ term.condensedName }}">
			    	                <div class="quarter-div-cover-drag" id="{{ term.condensedName }}-drag-cover"></div>
        						    <div class="quarter-div cover"></div>
            				        <div class="alert alert-error delete-alert">
                                	    <a class="close" href="#" onclick="cancelDeleteCourse('{{ term.condensedName }}');">&times;</a>
                                	    <h4 class="alert-heading"></h4>
                                	    <span class="alert-body"></span>
                                	    <span class="alert-delete-course-id" style="display: none; visibility; hidden;"></span>
                                	    <span class="alert-delete-course-name" style="display: none; visibility; hidden;"></span>
                                	    <br />
                                	    <button class="btn btn-danger" onclick="confirmDeleteCourse('{{ term.condensedName }}');">Delete</button>
                                	    <button class="btn" onclick="cancelDeleteCourse('{{ term.condensedName }}');">Cancel</button>
                                    </div>
			    	                <div class="courses-div" id="{{ term.condensedName }}-courses">
        							    {% for course in term.courses %}
            				                <div id="{{ term.condensedName|add:course.condensedID }}" class="course">
            				                    <div class="courseName">{{ course.identifier }}</div>
            				                    <div class="grab-over">
            				                        <div class="grab-line" style="top: -7px;"></div>
            				                        <div class="grab-line" style="top: -11px;"></div>
            				                        <div class="grab-line" style="top: -15px;"></div>
        				                        </div>
            				                    <div class="info-over">
            				                        <div class="info" onclick="removeCourse(this);">
                                                        <i style="position: relative; top: 2px;" class="icon-remove icon-white"></i>
                                                    </div>
                                                </div>
            				                </div>
            							{% endfor %}
            						</div>
            						<div class="units-div" id="{{ term.condensedName }}-units-div">
            						    <span class="units" id="{{ term.condensedName }}-units">{{ term.units }}</span>
            						    <span class="calendar-over" onclick="openCalendar('{{ term.condensedName }}', this);">
                                            <span class="calendar-button"><i class="icon-calendar"></i></span>
                                        </span>
                                        &nbsp;<span class="added-units" id="{{ term.condensedName }}-added-units" style="display: none"></span>
            						</div>
        						</div>
        					</td>
        				{% endfor %}
        			</tr>
        		{% endfor %}
        		
        	</table>
	
	
        </td>
        
        <td style="padding-left: 20px; vertical-align: top;">
            
            <table>
                <tr>
                    <td>
                        
                        <div id="requirements-toolbox">
                            
                            <div id="search-div">
                                <div id="course-search-form">
                                    <input type="text" id="course-search" onkeyup="runSearch(event);" placeholder="Search for classes" class="input-medium search-query"/>
                                    <!-- <button class="btn" onclick="runSearch()">Search</button> -->
                                    <div id="search-spinner-over"><span id="search-spinner"></span></div>
                                </div>
                            </div>
                            <div id="breadcrumb-div">
                                <ul class="breadcrumb">
                                    <li id="blevel0" class="active"><span>Home</span><span class="longName">Home</span></li>
                                </ul>
                            </div>
                            
                            
                           <div id="content-div"></div>
                            
                        </div>
  
                       
                    </td>
                </tr>
                <!-- <tr style="height: 30px"><td>&nbsp;</td></tr> -->
                <tr>
                    <td>
                        <div id="plan-info-div">
                            <!-- <div class="plan-info-div-title">
                                 <h4><u>Plan information:</u></h4>
                             </div> -->
                            <div class="plan-info-div-inner">
                                <b>Major</b>: Computer Science
                                <br/>
                                <b>Total Units</b>: <span id="total-units"></span>
                                    <span id="total-units-icon"></span>
                                <br/>
                            </div>
                        </div>
            
                    </td>
                </tr>
                
            </table>
                                
            
        </td>
        
        
        
    </tr></table>    
        
</body>


</html>
